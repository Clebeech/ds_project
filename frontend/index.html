<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>832å·¥ç¨‹ - ä¸­å›½è„±è´«æ”»åšæ¡ˆä¾‹åº“</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Serif+SC:wght@400;600;700;900&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/fullpage.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/fullpage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/vendors/scrolloverflow.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    
    <style>
        :root {
            --theme-blue: #1e3a8a;   /* blue-900 */
            --theme-red: #b91c1c;    /* red-700 */
            --theme-text: #1e293b;   /* slate-800 */
            --theme-sub: #64748b;    /* slate-500 */
            --card-bg: #ffffff;
            --card-border: #e2e8f0;  /* slate-200 */
        }

        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* æ ‡é¢˜ä½¿ç”¨å®‹ä½“/è¡¬çº¿ä½“ */
        h1, h2, h3, h4, .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* æ”¿åŠ¡é£èƒŒæ™¯ - ææ·¡çš„å†·è‰²è°ƒ */
        .section-bg-hero {
            background: radial-gradient(circle at 50% 50%, #eff6ff 0%, #f8fafc 100%);
        }
        
        .section-bg-light {
            background-color: #f8fafc; /* slate-50 */
        }

        .section-bg-alt {
            background-color: #f1f5f9; /* slate-100 */
        }
        
        /* æ ¸å¿ƒæ•°å­— - å®å¿ƒæ·±è‰²ï¼Œæ›´æœ‰åˆ†é‡æ„Ÿ */
        .hero-number {
            font-size: 10rem;
            font-weight: 900;
            line-height: 1;
            color: var(--theme-blue);
            letter-spacing: -0.05em;
            position: relative;
            display: inline-block;
        }
        /* çº¢è‰²è£…é¥°ç‚¹ */
        .hero-number::after {
            content: '.';
            color: var(--theme-red);
        }
        
        .section-title {
            font-size: 3.5rem;
            font-weight: 900;
            color: #0f172a; /* slate-900 */
            letter-spacing: -0.02em;
        }
        
        .section-subtitle {
            font-size: 1rem;
            color: var(--theme-sub);
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        /* æ™ºåº“æŠ¥å‘Šå¡ç‰‡é£æ ¼ */
        .report-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-out;
        }
        
        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            border-color: #cbd5e1;
        }
        
        /* é€šç”¨è¾“å…¥æ¡†æ ·å¼ - ç™½åº•ç°è¾¹ */
        .input-standard {
            background-color: #fff;
            border: 1px solid #cbd5e1;
            color: #334155;
            transition: all 0.2s;
        }
        .input-standard:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        .input-standard::placeholder {
            color: #94a3b8;
        }
        
        .parallax-element {
            transition: transform 0.3s ease-out;
        }
        
        /* FullPage å¯¼èˆªç‚¹é¢œè‰²ä¿®æ­£ */
        #fp-nav ul li a span {
            background: #94a3b8 !important;
        }
        #fp-nav ul li a.active span {
            background: #1e3a8a !important;
            width: 12px;
            height: 12px;
            margin: -6px 0 0 -6px;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼è°ƒæ•´ */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #ffffff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* æƒé™æ§åˆ¶æ ·å¼ */
        body:not(.is-logged-in) .auth-only {
            display: none !important;
        }
        
        body:not(.is-logged-in) .guest-blur {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }
        
        .guest-lock-overlay {
            display: none;
        }
        
        body:not(.is-logged-in) .guest-lock-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(2px);
        }
        body:not(.is-logged-in) .guest-lock-overlay::after {
            content: 'ğŸ”’ è¯·ç™»å½•åˆ†æå¸ˆè´¦å·æŸ¥çœ‹';
            background: #1e293b;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">
    <!-- é¡¶éƒ¨å›ºå®šå¯¼èˆª/ç™»å½•çŠ¶æ€ -->
    <div class="fixed top-6 right-8 z-50 flex items-center gap-4">
        <div id="user-status" class="hidden text-sm font-medium text-slate-600 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-md border border-slate-200 transition-all">
            <span class="mr-3"><i class="fas fa-user-circle text-blue-600"></i> <span id="current-username">User</span> <span id="current-role" class="text-xs bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded ml-1 border border-slate-200">Guest</span></span>
            <button onclick="logout()" class="text-slate-400 hover:text-red-600 transition border-l border-slate-200 pl-3" title="é€€å‡ºç™»å½•">é€€å‡º</button>
        </div>
        <button id="login-btn" onclick="showLoginModal()" class="px-6 py-2.5 bg-slate-900/90 backdrop-blur hover:bg-slate-800 text-white text-sm font-bold rounded-full shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5 tracking-wide border border-slate-700">
            <i class="fas fa-lock mr-2 text-xs"></i> ç™»å½•
        </button>
    </div>

    <div id="fullpage">
        <div class="section section-bg-hero">
            <div class="flex items-center justify-center h-screen">
                <div class="text-center px-8 max-w-5xl">
                    <div class="mb-8 parallax-element" data-speed="0.5">
                         <div class="hero-number">832</div>
                    </div>
                    
                    <div class="inline-flex items-center px-3 py-1 rounded-full border border-red-200 bg-red-50 text-red-800 text-xs font-bold tracking-widest mb-6">
                        <span class="w-2 h-2 rounded-full bg-red-600 mr-2"></span>
                        å›½å®¶çº§è´«å›°å¿å…¨åå•æ•°æ®æ¡£æ¡ˆ
                    </div>
                    
                    <h1 class="text-5xl md:text-6xl font-black mb-6 text-slate-900 tracking-tight">ä¸­å›½è„±è´«æ”»åšæ¡ˆä¾‹åº“</h1>
                    <p class="text-xl text-slate-500 mb-12 mono max-w-2xl mx-auto leading-relaxed">
                        POVERTY ALLEVIATION CASE LIBRARY<br>
                        <span class="text-base font-sans mt-2 block opacity-80">åŸºäºå¤šç»´æ•°æ®çš„å¿åŸŸç»æµå‘å±•å›é¡¾ä¸ä¹¡æ‘æŒ¯å…´è·¯å¾„æ¢ç´¢</span>
                    </p>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="fullpage_api.moveTo(2)" class="px-8 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded shadow-lg hover:shadow-xl font-medium transition flex items-center transform hover:-translate-y-1">
                            <i class="fas fa-database mr-2 text-sm"></i> æ¢ç´¢æ•°æ®
                        </button>
                        <button onclick="fullpage_api.moveTo(3)" class="px-8 py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded shadow hover:shadow-md font-medium transition flex items-center">
                            <i class="fas fa-chart-line mr-2 text-sm"></i> å¿åŸŸåˆ†æ
                        </button>
                        <button onclick="fullpage_api.moveTo(7)" class="px-8 py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded shadow hover:shadow-md font-medium transition flex items-center">
                            <i class="fas fa-users mr-2 text-sm"></i> è°ƒç ”å›¢é˜Ÿ
                        </button>
                    </div>
                    
                    <div class="absolute bottom-8 left-0 right-0 text-center text-slate-400 text-xs uppercase tracking-widest">
                        Authorized Data Visualization System
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-light fp-auto-height">
            <div class="flex items-center justify-center min-h-screen px-8 py-12">
                <div class="max-w-7xl w-full">
                    <div class="text-center mb-12">
                        <h2 class="section-title">æ•°æ®æ¦‚è§ˆ</h2>
                        <p class="section-subtitle">Overview Statistics</p>
                    </div>
                    <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- å·¦åŠè¾¹ï¼šåœ°ç†åˆ†å¸ƒ -->
                        <div class="report-card bg-white rounded-xl p-6 shadow-sm">
                            <div class="flex items-center mb-4">
                                <div class="w-1 h-6 bg-blue-800 mr-3 rounded-full"></div>
                                <h3 class="text-xl font-bold text-slate-800 font-serif">832ä¸ªè´«å›°å¿åœ°ç†åˆ†å¸ƒ</h3>
                            </div>
                            <div id="counties-map" style="height: 500px;"></div>
                        </div>
                        <!-- å³åŠè¾¹ï¼šè®¿è°ˆè¯äº‘ -->
                        <div class="report-card bg-white rounded-xl p-6 shadow-sm">
                            <div class="flex items-center mb-4">
                                <div class="w-1 h-6 bg-purple-700 mr-3 rounded-full"></div>
                                <h3 class="text-xl font-bold text-slate-800 font-serif">è®¿è°ˆå…³é”®è¯è¯äº‘</h3>
                            </div>
                            <div id="wordcloud-chart" style="height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-alt">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-7xl w-full">
                    <div class="mb-8">
                        <h2 class="section-title text-4xl mb-2">å¿åŸŸæ¢ç´¢</h2>
                        <p class="section-subtitle">County Exploration</p>
                    </div>
                    
                    <div class="mb-6 flex gap-4 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <select id="region-filter" class="px-4 py-2 input-standard rounded-md w-32">
                            <option value="">å…¨éƒ¨åœ°åŒº</option>
                            <option value="ä¸œéƒ¨">ä¸œéƒ¨</option>
                            <option value="ä¸­éƒ¨">ä¸­éƒ¨</option>
                            <option value="è¥¿éƒ¨">è¥¿éƒ¨</option>
                        </select>
                        <select id="province-filter" class="px-4 py-2 input-standard rounded-md w-32">
                            <option value="">å…¨éƒ¨çœä»½</option>
                        </select>
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="è¾“å…¥å¿åæœç´¢..." class="w-full pl-10 px-4 py-2 input-standard rounded-md">
                        </div>
                        <button onclick="exportCounties()" id="export-counties-btn" class="hidden is-logged-in px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-semibold shadow-sm transition flex items-center whitespace-nowrap">
                            <i class="fas fa-download mr-2"></i> å¯¼å‡ºCSV
                        </button>
                    </div>
                    
                    <div id="counties-container" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4" style="max-height: 60vh; overflow-y: auto; padding: 4px; padding-right: 16px;">
                        </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-light fp-auto-height">
            <div class="flex items-center justify-center min-h-screen px-8">
                <div id="county-detail-content" class="max-w-7xl w-full py-12 overflow-y-auto" style="max-height: 100vh; padding-right: 24px; padding-left: 4px;">
                    <div class="flex items-end justify-between mb-10 border-b border-slate-200 pb-6">
                        <div>
                            <h2 class="section-title text-4xl mb-2" id="county-detail-title">å¿åŸŸè¯¦æƒ…</h2>
                            <p class="section-subtitle">County Detail Report</p>
                        </div>
                        <button onclick="fullpage_api.moveTo(3)" class="text-slate-500 hover:text-blue-700 transition">
                            <i class="fas fa-arrow-left mr-1"></i> è¿”å›åˆ—è¡¨
                        </button>
                    </div>
                    
                    <div class="mb-12">
                        <div class="flex items-center mb-6">
                            <div class="w-1 h-8 bg-blue-800 mr-3 rounded-full"></div>
                            <h3 class="text-2xl font-bold text-slate-800 font-serif">ç»æµæ•°æ®åˆ†æ</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">GDP å¢é•¿è¶‹åŠ¿</h4>
                                <div id="economy-gdp-chart" style="height: 300px;"></div>
                            </div>
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">äº§ä¸šç»“æ„å æ¯”</h4>
                                <div id="economy-structure-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">åŸä¹¡æ”¶å…¥æ°´å¹³</h4>
                                <div id="economy-income-chart" style="height: 300px;"></div>
                            </div>
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">è´¢æ”¿æ”¶æ”¯æƒ…å†µ</h4>
                                <div id="economy-fiscal-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <div class="flex items-center mb-6">
                            <div class="w-1 h-8 bg-green-700 mr-3 rounded-full"></div>
                            <h3 class="text-2xl font-bold text-slate-800 font-serif">å†œä¸šæ•°æ®åˆ†æ</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">å†œä¸šäº§å‡ºè§„æ¨¡</h4>
                                <div id="agriculture-output-chart" style="height: 300px;"></div>
                            </div>
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">å†œä½œç‰©ç§æ¤ç»“æ„</h4>
                                <div id="agriculture-crop-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">ä¸»è¦å†œä½œç‰©é¢ç§¯è¶‹åŠ¿</h4>
                            <div id="agriculture-area-chart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-alt">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-5xl w-full">
                    <div class="text-center mb-8">
                        <h2 class="section-title text-4xl">ç”°é‡è®¿è°ˆ</h2>
                        <p class="section-subtitle">Field Interview Records</p>
                    </div>
                    
                    <div class="mb-6 flex gap-4">
                        <button onclick="openInterviewFilter()" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-sm transition">
                            <i class="fas fa-filter mr-2"></i> é«˜çº§ç­›é€‰
                        </button>
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input type="text" id="interview-search" placeholder="æœç´¢è®¿è°ˆå†…å®¹å…³é”®è¯..." class="w-full pl-10 px-4 py-2 input-standard rounded-md">
                        </div>
                        <button onclick="exportInterviews()" id="export-interviews-btn" class="hidden is-logged-in px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-semibold shadow-sm transition flex items-center">
                            <i class="fas fa-download mr-2"></i> å¯¼å‡ºCSV
                        </button>
                    </div>
                    
                    <div id="interviews-container" class="space-y-4 pr-2" style="max-height: 60vh; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-light relative">
            <div class="guest-lock-overlay"></div>
            <div class="flex items-center justify-center h-screen px-8 guest-blur">
                <div class="max-w-7xl w-full">
                    <div class="mb-6">
                        <h2 class="section-title text-4xl mb-2">å¯¹æ¯”åˆ†æ</h2>
                        <p class="section-subtitle">Comparative Analysis</p>
                    </div>
                    
                    <div class="report-card bg-white p-6 rounded-xl mb-6">
                        <div class="flex gap-4 mb-4">
                            <button onclick="openCountySelector()" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-sm transition">
                                <i class="fas fa-plus mr-2"></i> æ·»åŠ å¯¹æ¯”å¿
                            </button>
                            <input type="text" id="compare-input" placeholder="æˆ–è¾“å…¥ä»£ç ï¼Œé€—å·åˆ†éš”ï¼ˆå¦‚ï¼š130125,410526ï¼‰" class="flex-1 px-4 py-2 input-standard rounded-md">
                            <button onclick="loadCompareData()" class="px-6 py-2 bg-purple-700 hover:bg-purple-800 text-white rounded-md font-semibold shadow-sm transition">
                                <i class="fas fa-chart-bar mr-2"></i> ç”Ÿæˆå›¾è¡¨
                            </button>
                        </div>
                        
                        <div id="selected-counties" class="flex flex-wrap gap-2 mb-4 min-h-[40px]">
                            <div class="text-sm text-slate-400 italic self-center">æš‚æœªé€‰æ‹©å¿åŸŸ</div>
                        </div>
                        
                        <div class="flex gap-4 flex-wrap">
                            <select id="compare-metric" class="px-4 py-2 input-standard rounded-md flex-1">
                                <option value="GDP">GDP (åœ°åŒºç”Ÿäº§æ€»å€¼)</option>
                                <option value="PerCapitaGDP">äººå‡GDP</option>
                                <option value="RuralDisposableIncome">å†œæ‘äººå‡å¯æ”¯é…æ”¶å…¥</option>
                                <option value="AgriOutputValue">å†œä¸šæ€»äº§å€¼</option>
                                <option value="FiscalRevenue">è´¢æ”¿æ”¶å…¥</option>
                                <option value="FiscalExpenditure">è´¢æ”¿æ”¯å‡º</option>
                                <option value="GrainOutput">ç²®é£Ÿäº§é‡</option>
                                <option value="MeatOutput">è‚‰ç±»äº§é‡</option>
                            </select>
                            <select id="compare-chart-type" class="px-4 py-2 input-standard rounded-md w-40">
                                <option value="line">æŠ˜çº¿å›¾</option>
                                <option value="bar">æŸ±çŠ¶å›¾</option>
                                <option value="area">é¢ç§¯å›¾</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="compare-chart-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="report-card bg-white p-4 rounded-xl shadow-sm">
                            <div id="compare-chart" style="height: 400px;"></div>
                        </div>
                        <div class="report-card bg-white p-4 rounded-xl shadow-sm">
                            <div id="compare-pie-chart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 7: è°ƒç ”å›¢é˜Ÿ -->
        <div class="section section-bg-alt">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-7xl w-full">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="section-title text-4xl mb-2">è°ƒç ”å›¢é˜Ÿ</h2>
                            <p class="section-subtitle">Survey Team</p>
                        </div>
                        <div class="flex gap-6 text-sm text-slate-500" id="surveyor-stats-bar">
                            <!-- Stats will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="mb-6 flex gap-4 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input type="text" id="surveyor-search" placeholder="æœç´¢è°ƒç ”å‘˜å§“åæˆ–ID..." class="w-full pl-10 px-4 py-2 input-standard rounded-md">
                        </div>
                        <input type="text" id="surveyor-county-code" placeholder="æŒ‰å¿ä»£ç ç­›é€‰" class="w-40 px-4 py-2 input-standard rounded-md">
                        <button onclick="loadSurveyors()" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-sm transition">
                            <i class="fas fa-filter mr-2"></i> ç­›é€‰
                        </button>
                        <button onclick="exportSurveyors()" id="export-surveyors-btn" class="hidden is-logged-in px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-semibold shadow-sm transition flex items-center">
                            <i class="fas fa-download mr-2"></i> å¯¼å‡ºCSV
                        </button>
                    </div>
                    
                    <div id="surveyors-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 overflow-y-auto" style="max-height: 60vh; padding: 4px;">
                        <!-- Cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="county-selector-modal" class="modal-backdrop fixed inset-0 z-[9999]" style="display: none;">
        <div class="flex items-center justify-center h-full w-full p-4">
            <div class="modal-content rounded-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                    <h3 class="text-2xl font-bold font-serif text-slate-800">é€‰æ‹©å¯¹æ¯”æ ·æœ¬</h3>
                    <button onclick="closeCountySelector()" class="text-slate-400 hover:text-slate-700 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="mb-4 flex gap-4">
                    <select id="selector-region" class="px-4 py-2 input-standard rounded-md">
                        <option value="">å…¨éƒ¨åœ°åŒº</option>
                        <option value="ä¸œéƒ¨">ä¸œéƒ¨</option>
                        <option value="ä¸­éƒ¨">ä¸­éƒ¨</option>
                        <option value="è¥¿éƒ¨">è¥¿éƒ¨</option>
                    </select>
                    <select id="selector-province" class="px-4 py-2 input-standard rounded-md">
                        <option value="">å…¨éƒ¨çœä»½</option>
                    </select>
                    <input type="text" id="selector-search" placeholder="æœç´¢å¿å..." class="flex-1 px-4 py-2 input-standard rounded-md">
                </div>
                <div id="county-selector-list" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6" style="max-height: 40vh; overflow-y: auto;">
                    </div>
                <div class="flex gap-4 pt-4 border-t border-slate-100">
                    <button onclick="applyCountySelection()" class="flex-1 px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-md transition">
                        <i class="fas fa-check mr-2"></i> ç¡®è®¤é€‰æ‹©
                    </button>
                    <button onclick="closeCountySelector()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md font-semibold transition">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="interview-filter-modal" class="modal-backdrop fixed inset-0 z-[9999]" style="display: none;">
        <div class="flex items-center justify-center h-full w-full p-4">
            <div class="modal-content rounded-xl p-8 max-w-lg w-full relative">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                    <h3 class="text-2xl font-bold font-serif text-slate-800">è®¿è°ˆç­›é€‰</h3>
                    <button onclick="closeInterviewFilter()" class="text-slate-400 hover:text-slate-700 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">å¿ä»£ç </label>
                        <input type="text" id="filter-county-code" placeholder="å¦‚ï¼š130125" class="w-full px-4 py-2 input-standard rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">è°ƒç ”å‘˜ID</label>
                        <input type="text" id="filter-surveyor-id" placeholder="å¦‚ï¼šDY20210002" class="w-full px-4 py-2 input-standard rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">å…³é”®è¯</label>
                        <input type="text" id="filter-keyword" placeholder="å†…å®¹æˆ–å—è®¿äººå§“å" class="w-full px-4 py-2 input-standard rounded-md">
                    </div>
                    <div class="flex gap-4 pt-6">
                        <button onclick="applyInterviewFilter()" class="flex-1 px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-md transition">
                            <i class="fas fa-search mr-2"></i> åº”ç”¨
                        </button>
                        <button onclick="resetInterviewFilter()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md font-semibold transition">
                            é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all">
            <div class="bg-slate-900 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white font-serif">åˆ†æå¸ˆç™»å½•</h3>
                <button onclick="closeLoginModal()" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8">
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-6">
                        <label class="block text-slate-600 text-sm font-bold mb-2" for="username">è´¦å·</label>
                        <input class="w-full px-4 py-3 rounded border border-slate-300 focus:border-blue-900 focus:ring-1 focus:ring-blue-900 outline-none transition" id="username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                    </div>
                    <div class="mb-8">
                        <label class="block text-slate-600 text-sm font-bold mb-2" for="password">å¯†ç </label>
                        <input class="w-full px-4 py-3 rounded border border-slate-300 focus:border-blue-900 focus:ring-1 focus:ring-blue-900 outline-none transition" id="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="flex items-center justify-between mb-6">
                        <div class="text-sm text-slate-500">é»˜è®¤è´¦å·: admin / admin123</div>
                    </div>
                    <button type="submit" class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded transition transform hover:-translate-y-0.5 shadow-md">
                        <span id="login-btn-text">ç™» å½•</span>
                    </button>
                </form>
                <div id="login-error" class="mt-4 text-center text-red-600 text-sm hidden"></div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-[100] hidden modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden transform transition-all flex flex-col max-h-[85vh]">
            <div class="bg-slate-900 px-6 py-4 flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-bold text-white font-serif"><i class="fas fa-cogs mr-2"></i> ç®¡ç†å‘˜æ§åˆ¶å°</h3>
                <button onclick="closeAdminModal()" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex border-b border-slate-200 bg-slate-50 flex-shrink-0">
                <button onclick="switchAdminTab('user')" id="tab-btn-user" class="flex-1 py-3 font-bold text-blue-900 border-b-2 border-blue-900 bg-white transition">ç”¨æˆ·ç®¡ç†</button>
                <button onclick="switchAdminTab('data')" id="tab-btn-data" class="flex-1 py-3 font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition">æ•°æ®å½•å…¥</button>
            </div>

            <div class="p-8 overflow-y-auto flex-1">
                <!-- ç”¨æˆ·ç®¡ç† Tab -->
                <div id="admin-tab-user">
                    <h4 class="text-xl font-bold text-slate-800 mb-4 font-serif">åˆ›å»ºåˆ†æå¸ˆè´¦å·</h4>
                    <p class="text-slate-500 mb-6 text-sm">åˆ›å»ºæ–°çš„åˆ†æå¸ˆè´¦å·ï¼Œåˆ†å‘ç»™å›¢é˜Ÿæˆå‘˜ä½¿ç”¨ã€‚æ–°è´¦å·å°†æ‹¥æœ‰å®Œæ•´çš„æ•°æ®è®¿é—®æƒé™ã€‚</p>
                    
                    <form onsubmit="handleCreateUser(event)" class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="new-username">ç”¨æˆ·å</label>
                                <input class="w-full px-4 py-2 input-standard rounded" id="new-username" type="text" placeholder="è®¾ç½®ç”¨æˆ·å" required>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="new-password">å¯†ç </label>
                                <input class="w-full px-4 py-2 input-standard rounded" id="new-password" type="text" placeholder="è®¾ç½®åˆå§‹å¯†ç " required>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow transition">
                                <i class="fas fa-user-plus mr-2"></i> åˆ›å»ºç”¨æˆ·
                            </button>
                        </div>
                    </form>
                    <div id="create-user-msg" class="mt-4 text-center hidden font-medium"></div>
                </div>

                <!-- æ•°æ®å½•å…¥ Tab -->
                <div id="admin-tab-data" class="hidden">
                    <h4 class="text-xl font-bold text-slate-800 mb-4 font-serif">å½•å…¥è®¿è°ˆè®°å½•</h4>
                    <p class="text-slate-500 mb-6 text-sm">å½•å…¥æ–°çš„è®¿è°ˆæ•°æ®ã€‚ç³»ç»Ÿå°†é€šè¿‡æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°è°ƒç ”å‘˜çš„"å·²å®Œæˆè®¿è°ˆæ¬¡æ•°"ã€‚</p>
                    
                    <form onsubmit="handleCreateInterview(event)" class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">å¿åŸŸä»£ç </label>
                                <input class="w-full px-4 py-2 input-standard rounded" id="entry-county" type="text" placeholder="å¦‚: 130125" required>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">è°ƒç ”å‘˜ID</label>
                                <input class="w-full px-4 py-2 input-standard rounded" id="entry-surveyor" type="text" placeholder="å¦‚: S2021001" required>
                            </div>
                        </div>
                        <div class="mb-4">
                             <label class="block text-slate-700 text-sm font-bold mb-2">è®¿è°ˆå†…å®¹</label>
                             <textarea class="w-full px-4 py-2 input-standard rounded h-32" id="entry-content" placeholder="åœ¨æ­¤è¾“å…¥è®¿è°ˆçºªè¦..." required></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold shadow transition">
                                <i class="fas fa-save mr-2"></i> ä¿å­˜è®°å½•
                            </button>
                        </div>
                    </form>
                    <div id="create-interview-msg" class="mt-4 text-center hidden font-medium"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è°ƒç ”å‘˜è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="surveyor-detail-modal" class="modal-backdrop fixed inset-0 z-[9999]" style="display: none;">
        <div class="flex items-center justify-center h-full w-full p-4">
            <div class="modal-content rounded-xl p-8 max-w-lg w-full relative">
                <div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold" id="detail-avatar">
                            <!-- Initials -->
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold font-serif text-slate-800" id="detail-name">å§“å</h3>
                            <p class="text-slate-500 text-sm" id="detail-id">ID</p>
                        </div>
                    </div>
                    <button onclick="closeSurveyorDetail()" class="text-slate-400 hover:text-slate-700 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">æ‰€å±åˆ†é˜Ÿ</label>
                            <p class="font-medium text-slate-700" id="detail-team">--</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">è°ƒç ”è§’è‰²</label>
                            <p class="font-medium text-slate-700" id="detail-role">--</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">å­¦å†/ä¸“ä¸š</label>
                            <p class="font-medium text-slate-700" id="detail-edu">--</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">æ‰€å±é™¢ç³»</label>
                            <p class="font-medium text-slate-700" id="detail-dept">--</p>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold text-slate-600">è´Ÿè´£å¿åŸŸ</span>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full" id="detail-county-code">--</span>
                        </div>
                        <p class="text-lg font-serif font-bold text-blue-900" id="detail-county-name">--</p>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">è”ç³»æ–¹å¼ <span class="font-normal text-xs lowercase ml-1">(ä»…ç‰¹å®šè§’è‰²å¯è§)</span></label>
                        <div class="flex flex-col gap-1 mt-1">
                            <div class="flex items-center gap-2 text-sm text-slate-700">
                                <i class="fas fa-phone-alt w-5 text-slate-400"></i>
                                <span id="detail-phone">***********</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-slate-700">
                                <i class="fas fa-envelope w-5 text-slate-400"></i>
                                <span id="detail-email">***********</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">ä¸“é•¿ & å¤‡æ³¨</label>
                        <p class="text-sm text-slate-600 mt-1 leading-relaxed" id="detail-expertise">--</p>
                        <p class="text-sm text-slate-500 mt-2 italic border-t border-slate-100 pt-2" id="detail-notes">--</p>
                    </div>

                    <div class="pt-4 border-t border-slate-100 mt-4">
                        <button onclick="viewSurveyorInterviews()" class="w-full px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-bold shadow-md transition flex items-center justify-center gap-2">
                            <i class="fas fa-file-alt"></i>
                            <span>æŸ¥çœ‹è¯¥è°ƒç ”å‘˜çš„è®¿è°ˆè®°å½•</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * æ™ºåº“é£ App Logic
         * æ•´åˆäº†åŸ app.js å¹¶ä¿®æ”¹äº†æ¸²æŸ“é€»è¾‘ä»¥é€‚é…æ–°é£æ ¼
         */

        // APIåŸºç¡€URL
        const API_BASE = 'http://localhost:5001/api';

        // æ‹¦æˆª fetch è¯·æ±‚ï¼Œè‡ªåŠ¨æ·»åŠ  credentials: 'include' ä»¥æ”¯æŒè·¨åŸŸ Cookie
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            options = options || {};
            // åªæœ‰è¯·æ±‚ API_BASE æ—¶æ‰æ·»åŠ  credentials
            if (typeof url === 'string' && url.includes(API_BASE)) {
                options.credentials = 'include';
            }
            return originalFetch(url, options);
        };

        // ç”¨æˆ·è®¤è¯ç›¸å…³é€»è¾‘
        let currentUser = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const res = await fetch(`${API_BASE}/auth/me`);
                const data = await res.json();
                if (data.success && data.user) {
                    updateUserUI(data.user);
                } else {
                    updateUserUI(null);
                }
            } catch (e) {
                console.error("Auth check failed", e);
                updateUserUI(null);
            }
        }

        function updateUserUI(user) {
            currentUser = user;
            const statusDiv = document.getElementById('user-status');
            const loginBtn = document.getElementById('login-btn');
            
            if (user) {
                statusDiv.classList.remove('hidden');
                statusDiv.classList.add('flex');
                loginBtn.classList.add('hidden');
                document.getElementById('current-username').textContent = user.username;
                document.getElementById('current-role').textContent = user.role;
                
                document.body.classList.add('is-logged-in');
                
                // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
                const exportBtns = document.querySelectorAll('[id^="export-"]');
                exportBtns.forEach(btn => {
                    if (btn.classList.contains('is-logged-in')) {
                        btn.classList.remove('hidden');
                    }
                });
                
                // Clean up old admin button if exists
                const existingAdminBtn = document.getElementById('admin-btn');
                if (existingAdminBtn) existingAdminBtn.remove();

                if (user.role === 'admin' || user.role === 'surveyor') {
                    if (user.role === 'admin') document.body.classList.add('is-admin');
                    
                    // Add admin/surveyor button
                    const actionBtn = document.createElement('button');
                    actionBtn.id = 'admin-btn';
                    const btnText = user.role === 'admin' ? 'ç®¡ç†' : 'å·¥ä½œå°';
                    const btnIcon = user.role === 'admin' ? 'cogs' : 'edit';
                    actionBtn.innerHTML = `<i class="fas fa-${btnIcon} text-xs"></i> ${btnText}`;
                    actionBtn.className = 'ml-3 px-3 py-1 bg-slate-800 text-white text-xs rounded hover:bg-slate-700 transition';
                    actionBtn.onclick = showAdminModal;
                    document.getElementById('user-status').insertBefore(actionBtn, document.getElementById('user-status').lastElementChild);
                }
            } else {
                statusDiv.classList.add('hidden');
                statusDiv.classList.remove('flex');
                loginBtn.classList.remove('hidden');
                
                document.body.classList.remove('is-logged-in', 'is-admin');
                
                // éšè—å¯¼å‡ºæŒ‰é’®
                const exportBtns = document.querySelectorAll('[id^="export-"]');
                exportBtns.forEach(btn => {
                    if (btn.classList.contains('is-logged-in')) {
                        btn.classList.add('hidden');
                    }
                });
            }
        }

        function showLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            document.getElementById('login-error').classList.add('hidden');
            if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
        }

        // Admin Modal Logic
        function showAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);

            // è§’è‰²é€‚é…
            const userTab = document.getElementById('admin-tab-user');
            const dataTab = document.getElementById('admin-tab-data');
            const userBtn = document.getElementById('tab-btn-user');
            const dataBtn = document.getElementById('tab-btn-data');

            if (currentUser && currentUser.role === 'surveyor') {
                // è°ƒç ”å‘˜æ¨¡å¼ï¼šéšè—ç”¨æˆ·ç®¡ç†Tabï¼Œç›´æ¥æ˜¾ç¤ºæ•°æ®å½•å…¥
                userBtn.style.display = 'none';
                dataBtn.style.display = 'none'; // éšè—Tabåˆ‡æ¢æ ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªåŠŸèƒ½
                
                userTab.classList.add('hidden');
                dataTab.classList.remove('hidden');
            } else {
                // ç®¡ç†å‘˜æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰Tab
                userBtn.style.display = '';
                dataBtn.style.display = '';
                
                // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ª
                switchAdminTab('user');
            }
        }

        function closeAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
        }

        function switchAdminTab(tab) {
            const userTab = document.getElementById('admin-tab-user');
            const dataTab = document.getElementById('admin-tab-data');
            const userBtn = document.getElementById('tab-btn-user');
            const dataBtn = document.getElementById('tab-btn-data');

            if (tab === 'user') {
                userTab.classList.remove('hidden');
                dataTab.classList.add('hidden');
                userBtn.className = 'flex-1 py-3 font-bold text-blue-900 border-b-2 border-blue-900 bg-white transition';
                dataBtn.className = 'flex-1 py-3 font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition';
            } else {
                userTab.classList.add('hidden');
                dataTab.classList.remove('hidden');
                dataBtn.className = 'flex-1 py-3 font-bold text-blue-900 border-b-2 border-blue-900 bg-white transition';
                userBtn.className = 'flex-1 py-3 font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition';
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const msgDiv = document.getElementById('create-user-msg');
            
            msgDiv.classList.add('hidden');
            
            try {
                const res = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role: 'analyst' })
                });
                const data = await res.json();
                
                msgDiv.classList.remove('hidden');
                if (data.success) {
                    msgDiv.textContent = `âœ… ç”¨æˆ· ${username} åˆ›å»ºæˆåŠŸ`;
                    msgDiv.className = 'mt-4 text-center font-medium text-green-600';
                    e.target.reset();
                } else {
                    msgDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${data.error}`;
                    msgDiv.className = 'mt-4 text-center font-medium text-red-600';
                }
            } catch (err) {
                msgDiv.classList.remove('hidden');
                msgDiv.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                msgDiv.className = 'mt-4 text-center font-medium text-red-600';
            }
        }

        async function handleCreateInterview(e) {
            e.preventDefault();
            const county_code = document.getElementById('entry-county').value;
            const surveyor_id = document.getElementById('entry-surveyor').value;
            const content = document.getElementById('entry-content').value;
            const msgDiv = document.getElementById('create-interview-msg');
            
            msgDiv.classList.add('hidden');
            
            try {
                const res = await fetch(`${API_BASE}/interviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ county_code, surveyor_id, content })
                });
                const data = await res.json();
                
                msgDiv.classList.remove('hidden');
                if (data.success) {
                    msgDiv.textContent = `âœ… è®¿è°ˆè®°å½•ä¿å­˜æˆåŠŸ (ID: ${data.interview_id})`;
                    msgDiv.className = 'mt-4 text-center font-medium text-green-600';
                    e.target.reset();
                } else {
                    msgDiv.textContent = `âŒ ä¿å­˜å¤±è´¥: ${data.error}`;
                    msgDiv.className = 'mt-4 text-center font-medium text-red-600';
                }
            } catch (err) {
                msgDiv.classList.remove('hidden');
                msgDiv.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                msgDiv.className = 'mt-4 text-center font-medium text-red-600';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    closeLoginModal();
                    updateUserUI(data.user);
                    location.reload(); 
                } else {
                    errorDiv.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                errorDiv.classList.remove('hidden');
            }
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
            } catch (e) {}
            updateUserUI(null);
            location.reload(); 
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('load', checkLoginStatus);

        // å…¨å±€å›¾è¡¨ä¸»é¢˜é…ç½® (Light Mode / Think Tank Style)
        const CHART_THEME = {
            textStyle: { fontFamily: 'Inter, sans-serif', color: '#475569' }, // slate-600
            title: { textStyle: { color: '#1e293b', fontFamily: 'Noto Serif SC, serif', fontWeight: 'bold' } },
            grid: { left: '10%', right: '5%', top: '15%', bottom: '10%', containLabel: true },
            axisLine: { lineStyle: { color: '#cbd5e1' } }, // slate-300
            axisLabel: { color: '#64748b' }, // slate-500
            splitLine: { lineStyle: { color: '#f1f5f9', type: 'dashed' } }, // slate-100
            // é…è‰²æ–¹æ¡ˆï¼šæ·±è“, ç¿ ç»¿, ç¥ç€, æ·±çº¢, ç´«
            colors: ['#1e3a8a', '#059669', '#d97706', '#b91c1c', '#7c3aed'],
            backgroundColor: 'transparent',
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                borderWidth: 1,
                textStyle: { color: '#1e293b' },
                extraCssText: 'box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);'
            }
        };

        // åˆå§‹åŒ–FullPage.js
        let fullpage_api;
        document.addEventListener('DOMContentLoaded', function() {
            fullpage_api = new fullpage('#fullpage', {
                licenseKey: 'gplv3-license',
                navigation: true,
                navigationPosition: 'right',
                scrollingSpeed: 700,
                parallax: true,
                scrollOverflow: true,
                scrollOverflowOptions: {
                    scrollbars: true,
                    mouseWheel: true,
                    hideScrollbars: false,
                    fadeScrollbars: false
                },
                normalScrollElements: '#county-detail-content, #counties-container, #interviews-container, #county-selector-list',
                onLeave: function(origin, destination, direction) {
                    const parallaxElements = destination.item.querySelectorAll('.parallax-element');
                    parallaxElements.forEach(el => {
                        el.style.transform = 'translateY(0)';
                    });
                }
            });
            
            // åŠ è½½åˆå§‹æ•°æ®
            loadOverviewStats();
            loadCountiesMap();
            loadWordcloud(); // åŠ è½½è¯äº‘å›¾
            loadProvinces();
            loadCounties();

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè®©æ‰€æœ‰ ECharts å›¾è¡¨è‡ªåŠ¨è°ƒæ•´å®½åº¦
            window.addEventListener('resize', function() {
                // æ‰¾åˆ°é¡µé¢ä¸Šæ‰€æœ‰å·²ç»è¢« ECharts æ¸²æŸ“è¿‡çš„ div
                const charts = document.querySelectorAll('div[_echarts_instance_]');
                
                charts.forEach(dom => {
                    //ä»¥æ­¤ DOM è·å–å¯¹åº”çš„ ECharts å®ä¾‹
                    const instance = echarts.getInstanceByDom(dom);
                    if (instance) {
                        // å‘½ä»¤è¯¥å®ä¾‹é‡æ–°è®¡ç®—å®½åº¦
                        instance.resize();
                    }
                });
            });
        });

        // åŠ è½½æ¦‚è§ˆç»Ÿè®¡ (æ–°æ ·å¼)
        async function loadOverviewStats() {
            try {
                const response = await fetch(`${API_BASE}/stats/overview`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    const container = document.getElementById('stats-container');
                    
                    container.innerHTML = `
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">è´«å›°å¿æ€»æ•°</div>
                                    <div class="text-5xl font-black text-slate-800">${stats.poverty_counties}</div>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-full text-blue-700"><i class="fas fa-map-marker-alt"></i></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">å·²æ‘˜å¸½å¿æ•°</div>
                                    <div class="text-5xl font-black text-green-700">${stats.exited_counties}</div>
                                </div>
                                <div class="p-3 bg-green-50 rounded-full text-green-700"><i class="fas fa-check-circle"></i></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">è®¿è°ˆå®å½•</div>
                                    <div class="text-5xl font-black text-slate-800">${stats.interviews}</div>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-full text-purple-700"><i class="fas fa-comments"></i></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">è°ƒç ”äººå‘˜</div>
                                    <div class="text-5xl font-black text-slate-800">${stats.surveyors}</div>
                                </div>
                                <div class="p-3 bg-orange-50 rounded-full text-orange-600"><i class="fas fa-user-friends"></i></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // Fallback UI if API fails
                document.getElementById('stats-container').innerHTML = `<div class="col-span-4 text-center text-slate-400 py-10">æ— æ³•è¿æ¥æ•°æ®æœåŠ¡å™¨ (${API_BASE})</div>`;
            }
        }

        // åŠ è½½å¹¶æ¸²æŸ“åœ°å›¾
        async function loadCountiesMap() {
            try {
                // 1. å¹¶è¡ŒåŠ è½½åœ°å›¾æ•°æ®å’Œå¿åŸŸæ•°æ®
                // ä¼˜åŒ–ï¼šä½¿ç”¨ 100000.json (æ ‡å‡†ç²¾åº¦) ä»£æ›¿ 100000_full.json (é«˜ç²¾åº¦)ï¼Œå¤§å¹…å‡å°‘æ¸²æŸ“å¼€é”€
                const [mapResponse, countiesResponse] = await Promise.all([
                    fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000.json'),
                    fetch(`${API_BASE}/counties/map`)
                ]);

                const mapJson = await mapResponse.json();
                const result = await countiesResponse.json();
                
                if (result.success && result.data.length > 0) {
                    // æ³¨å†Œåœ°å›¾
                    echarts.registerMap('china', mapJson);
                    
                    const mapData = result.data;
                    // é”€æ¯æ—§å®ä¾‹ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
                    const chartDom = document.getElementById('counties-map');
                    echarts.dispose(chartDom);
                    const mapChart = echarts.init(chartDom);
                    
                    // å‡†å¤‡æ•°æ®ï¼š[ç»åº¦, çº¬åº¦, GDP, å¿ä»£ç , å¿å]
                    const data = mapData
                        .filter(d => d.Longitude && d.Latitude)
                        .map(d => ({
                            name: d.CountyName,
                            value: [
                                parseFloat(d.Longitude),
                                parseFloat(d.Latitude),
                                d.GDP || 0,
                                d.CountyCode
                            ]
                        }));
                    
                    // è®¡ç®—GDPèŒƒå›´
                    const gdpValues = data.map(d => d.value[2]).filter(v => v > 0);
                    const minGDP = gdpValues.length > 0 ? Math.min(...gdpValues) : 0;
                    const maxGDP = gdpValues.length > 0 ? Math.max(...gdpValues) : 100000;
                    
                    const option = {
                        backgroundColor: '#f8fafc',
                        title: {
                            text: '832ä¸ªè´«å›°å¿ GDP åˆ†å¸ƒçƒ­åŠ›å›¾',
                            left: 'center',
                            top: 20,
                            textStyle: {
                                color: '#1e293b',
                                fontFamily: 'Noto Serif SC',
                                fontSize: 20
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#e2e8f0',
                            textStyle: { color: '#1e293b' },
                            formatter: function(params) {
                                const val = params.value;
                                const gdp = val[2] ? (val[2] / 10000).toFixed(2) + ' äº¿å…ƒ' : 'æš‚æ— æ•°æ®';
                                return `
                                    <div class="font-bold mb-1">${params.name}</div>
                                    <div class="text-sm text-slate-500">GDP: <span class="font-bold text-blue-700">${gdp}</span></div>
                                    <div class="text-xs text-slate-400 mt-1">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                                `;
                            }
                        },
                        visualMap: {
                            min: minGDP,
                            max: maxGDP / 2,
                            calculable: true,
                            realtime: false, // æ‹–åŠ¨æ»‘å—æ—¶ä¸éœ€è¦å®æ—¶æ¸²æŸ“ï¼Œæ¾å¼€å†æ¸²æŸ“
                            inRange: {
                                color: ['#3b82f6', '#06b6d4', '#facc15', '#ef4444', '#b91c1c']
                            },
                            textStyle: { color: '#64748b' },
                            left: 'left',
                            bottom: '20',
                            text: ['GDP é«˜', 'GDP ä½'],
                            formatter: function(value) {
                                return (value / 10000).toFixed(0) + 'äº¿';
                            }
                        },
                        geo: {
                            map: 'china',
                            roam: false, // ç¦æ­¢ç¼©æ”¾å’Œå¹³ç§»ï¼Œå›ºå®šåœ°å›¾ä½ç½®
                            // ä½¿ç”¨ layoutCenter å’Œ layoutSize ç¡®ä¿åœ°å›¾åœ¨å®¹å™¨ä¸­å±…ä¸­ä¸”å¤§å°åˆé€‚
                            layoutCenter: ['50%', '60%'], // ä¸‹ç§»ä¸€ç‚¹ (50% -> 60%)
                            layoutSize: '100%', // åœ°å›¾å¤§å°å å®¹å™¨çš„æ¯”ä¾‹
                            itemStyle: {
                                areaColor: '#e2e8f0',
                                borderColor: '#fff',
                                borderWidth: 1
                            },
                            emphasis: {
                                disabled: true,
                                itemStyle: { areaColor: '#e2e8f0' }
                            }
                        },
                        series: [
                            {
                                name: 'GDPåˆ†å¸ƒ',
                                type: 'scatter',
                                coordinateSystem: 'geo',
                                data: data,
                                // å…³é—­ large æ¨¡å¼ï¼Œ800ä¸ªç‚¹ä¸éœ€è¦å¼€å¯ï¼Œå¼€å¯ä¼šå¯¼è‡´ symbolSize å›è°ƒå¤±æ•ˆ
                                // large: true,
                                // largeThreshold: 500,
                                // progressive: 500,
                                zlevel: 2, // ç¡®ä¿åœ¨åœ°å›¾ä¹‹ä¸Š
                                
                                symbolSize: function(val) {
                                    if (!val || val.length < 3) return 4;
                                    const gdp = val[2];
                                    if (gdp <= 0) return 4;
                                    // çº¿æ€§æ˜ å°„ï¼šæœ€å°5pxï¼Œæœ€å¤§15px
                                    const size = 5 + (gdp - minGDP) / (maxGDP - minGDP) * 15;
                                    return isNaN(size) ? 4 : Math.min(Math.max(size, 4), 20);
                                },
                                itemStyle: {
                                    opacity: 0.9,
                                    borderColor: 'rgba(255,255,255,0.3)',
                                    borderWidth: 1
                                },
                                emphasis: {
                                    scale: true,
                                    itemStyle: {
                                        borderColor: '#fff',
                                        borderWidth: 2,
                                        opacity: 1
                                    }
                                }
                            }
                        ]
                    };
                    
                    mapChart.setOption(option);
                    
                    // ç‚¹å‡»è·³è½¬
                    mapChart.on('click', function(params) {
                        if (params.value && params.value[3]) {
                            showCountyDetail(params.value[3]);
                        }
                    });
                    
                    window.addEventListener('resize', () => mapChart.resize());
                }
            } catch (error) {
                console.error('åŠ è½½åœ°å›¾æ•°æ®å¤±è´¥:', error);
                document.getElementById('counties-map').innerHTML = 
                    '<div class="flex items-center justify-center h-full text-slate-400">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            }
        }

        // åŠ è½½çœä»½åˆ—è¡¨
        async function loadProvinces() {
            try {
                const response = await fetch(`${API_BASE}/counties`);
                const result = await response.json();
                
                if (result.success) {
                    const provinces = [...new Set(result.data
                        .filter(c => c.Province && c.Province !== 'æœªçŸ¥')
                        .map(c => c.Province)
                    )].sort();
                    
                    const select = document.getElementById('province-filter');
                    if (select) {
                        const allOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        if (allOption) select.appendChild(allOption);
                        provinces.forEach(province => {
                            const option = document.createElement('option');
                            option.value = province;
                            option.textContent = province;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) { console.error(error); }
        }

        // åŠ è½½å¿åˆ—è¡¨ (å¸¦éª¨æ¶å±)
        async function loadCounties(filters = {}) {
            const container = document.getElementById('counties-container');
            
            // 1. æ¸²æŸ“éª¨æ¶å± (Loading State)
            // ç”Ÿæˆ 8 ä¸ªé—ªçƒçš„å¡ç‰‡å ä½
            const skeletonHTML = Array(8).fill(0).map(() => `
                <div class="report-card bg-white rounded-lg p-5 border border-slate-100">
                    <div class="animate-pulse flex space-x-4">
                        <div class="flex-1 space-y-4 py-1">
                            <div class="flex justify-between">
                                <div class="h-6 bg-slate-200 rounded w-1/3"></div>
                                <div class="h-6 bg-slate-200 rounded w-1/4"></div>
                            </div>
                            <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                            <div class="space-y-2 pt-2">
                                <div class="h-4 bg-slate-200 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = skeletonHTML;

            try {
                const params = new URLSearchParams();
                if (filters.region) params.append('region', filters.region);
                if (filters.province) params.append('province', filters.province);
                
                const response = await fetch(`${API_BASE}/counties?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const validCounties = result.data.filter(county => 
                        county.CountyName && !county.CountyName.startsWith('å¿ä»£ç ')
                    );
                    
                    // æ’åºé€»è¾‘...
                    validCounties.sort((a, b) => {
                        const aCompleteness = a.DataCompleteness || 0;
                        const bCompleteness = b.DataCompleteness || 0;
                        if (aCompleteness !== bCompleteness) return bCompleteness - aCompleteness;
                        if (a.ExitYear && !b.ExitYear) return -1;
                        if (!a.ExitYear && b.ExitYear) return 1;
                        return (a.CountyName || '').localeCompare(b.CountyName || '');
                    });
                    
                    const counties = validCounties.slice(0, 12);
                    
                    if (counties.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-8 text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¿åŸŸæ•°æ®</div>';
                        return;
                    }
                    
                    // 2. æ¸²æŸ“çœŸå®æ•°æ® (Real Data)
                    container.innerHTML = counties.map(county => `
                        <div class="report-card bg-white rounded-lg p-5 cursor-pointer group hover:border-blue-300 transition-all duration-300" onclick="showCountyDetail('${county.CountyCode}')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-bold text-lg text-slate-800 font-serif group-hover:text-blue-800 transition-colors">
                                    ${county.CountyName || county.CountyCode}
                                </div>
                                ${county.ExitYear ? `<span class="px-2 py-0.5 bg-green-50 text-green-700 text-xs font-bold rounded border border-green-100">æ‘˜å¸½ ${county.ExitYear}</span>` : ''}
                            </div>
                            <div class="text-sm text-slate-500 mb-3 flex items-center">
                                <i class="fas fa-map-marker-alt mr-2 text-slate-300"></i> 
                                ${county.Province || 'æœªçŸ¥'} Â· ${county.City || 'æœªçŸ¥'}
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-slate-50">
                                <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">${county.Region || 'æœªçŸ¥åŒºåŸŸ'}</span>
                                <span class="text-xs text-blue-600 font-medium opacity-0 -translate-x-2 group-hover:translate-x-0 group-hover:opacity-100 transition-all">æŸ¥çœ‹è¯¦æƒ… <i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) { console.error(error); }
        }

        // æ˜¾ç¤ºå¿è¯¦æƒ…
        async function showCountyDetail(countyCode) {
            try {
                const countyRes = await fetch(`${API_BASE}/counties/${countyCode}`);
                const countyData = await countyRes.json();
                if (countyData.success) {
                    document.getElementById('county-detail-title').textContent = countyData.data.CountyName;
                }
                
                const economyRes = await fetch(`${API_BASE}/counties/${countyCode}/economy?start_year=2010&end_year=2020`);
                const economyData = await economyRes.json();
                if (economyData.success && economyData.data.length > 0) {
                    renderEconomyCharts(economyData.data);
                }
                
                const agriRes = await fetch(`${API_BASE}/counties/${countyCode}/agriculture?start_year=2010&end_year=2020`);
                const agriData = await agriRes.json();
                if (agriData.success && agriData.data.length > 0) {
                    renderAgricultureCharts(agriData.data, countyCode);
                }
                
                fullpage_api.moveTo(4);
            } catch (error) { console.error(error); }
        }

        // è®¡ç®—å¢é•¿ç‡å’Œè¶‹åŠ¿çš„è¾…åŠ©å‡½æ•°
        function calculateGrowth(dataArray) {
            if (!dataArray || dataArray.length < 2) return null;
            const first = parseFloat(dataArray[0]) || 0;
            const last = parseFloat(dataArray[dataArray.length - 1]) || 0;
            if (first === 0) return null;
            
            const growthRate = ((last - first) / first * 100).toFixed(1);
            let tag = '';
            let colorClass = '';
            
            if (growthRate > 100) { tag = 'é«˜é€Ÿå¢é•¿'; colorClass = 'bg-red-50 text-red-700 border-red-200'; }
            else if (growthRate > 50) { tag = 'æ˜¾è‘—æå‡'; colorClass = 'bg-blue-50 text-blue-700 border-blue-200'; }
            else if (growthRate > 0) { tag = 'å¹³ç¨³å‘å±•'; colorClass = 'bg-green-50 text-green-700 border-green-200'; }
            else { tag = 'éœ€å…³æ³¨'; colorClass = 'bg-orange-50 text-orange-700 border-orange-200'; }
            
            return { rate: growthRate, tag, color: colorClass, value: last };
        }

        // æ¸²æŸ“ç»æµå›¾è¡¨ (å¸¦æ™ºåº“æ´å¯Ÿç‰ˆ)
        function renderEconomyCharts(data) {
            const years = data.map(d => d.Year);
            const latest = data[data.length - 1];
            
            // --- 1. GDPè¶‹åŠ¿å›¾ (å¸¦æ´å¯Ÿ) ---
            const gdpContainer = document.getElementById('economy-gdp-chart');
            const gdpData = data.map(d => d.GDP ? (d.GDP / 10000).toFixed(2) : 0);
            
            // è®¡ç®—æ´å¯ŸæŒ‡æ ‡
            const gdpInsight = calculateGrowth(gdpData);
            
            // åŠ¨æ€æ’å…¥æ´å¯Ÿæ ‡ç­¾ (Insight Badge)
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ’å…¥åˆ°å›¾è¡¨å®¹å™¨çš„å‰é¢
            if (gdpInsight) {
                const insightHTML = `
                    <div class="absolute top-4 right-4 z-10 flex gap-2">
                        <span class="px-2 py-1 text-xs font-bold rounded border ${gdpInsight.color}">
                            ${gdpInsight.tag}
                        </span>
                        <span class="px-2 py-1 text-xs font-bold rounded border bg-slate-50 text-slate-600 border-slate-200">
                            10å¹´å¢é•¿: ${gdpInsight.rate > 0 ? '+' : ''}${gdpInsight.rate}%
                        </span>
                    </div>
                `;
                // ä¸ºäº†é˜²æ­¢é‡å¤æ·»åŠ ï¼Œå…ˆæ¸…ç©ºä¹‹å‰çš„écanvaså…ƒç´ ï¼Œæˆ–è€…ç®€å•åœ°è®¾ç½®çˆ¶å®¹å™¨ç›¸å¯¹å®šä½
                gdpContainer.parentElement.style.position = 'relative';
                // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„hackï¼ŒæŠŠæ´å¯Ÿæ•°æ®ç›´æ¥è¿½åŠ åˆ°çˆ¶å®¹å™¨é‡Œï¼Œæˆ–è€…ç”±ECharts Titleå¤„ç†
                // ä¸ºäº†ä¸ç ´åå¸ƒå±€ï¼Œæˆ‘ä»¬åˆ©ç”¨ ECharts çš„ graphic ç»„ä»¶æˆ–è€… title ç»„ä»¶æ›´ç¨³å¦¥
            }

            const gdpChart = echarts.init(gdpContainer);
            gdpChart.setOption({
                ...CHART_THEME,
                // åˆ©ç”¨ ECharts Title æ˜¾ç¤ºæ´å¯Ÿæ•°æ®ï¼Œè§„é¿ DOM æ“ä½œçš„éº»çƒ¦
                title: {
                    text: gdpInsight ? `{tag|${gdpInsight.tag}}  {rate|å¢é•¿ç‡: ${gdpInsight.rate}%}` : '',
                    right: 0,
                    top: 0,
                    textStyle: {
                        rich: {
                            tag: {
                                backgroundColor: gdpInsight?.tag === 'é«˜é€Ÿå¢é•¿' ? '#fef2f2' : '#eff6ff',
                                color: gdpInsight?.tag === 'é«˜é€Ÿå¢é•¿' ? '#b91c1c' : '#1d4ed8',
                                borderRadius: 4,
                                padding: [4, 8],
                                fontSize: 12,
                                fontWeight: 'bold',
                                borderColor: gdpInsight?.tag === 'é«˜é€Ÿå¢é•¿' ? '#fecaca' : '#bfdbfe',
                                borderWidth: 1
                            },
                            rate: {
                                color: '#64748b',
                                padding: [4, 0, 4, 5],
                                fontSize: 12
                            }
                        }
                    }
                },
                tooltip: { ...CHART_THEME.tooltip, trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: years,
                    axisLine: CHART_THEME.axisLine,
                    axisLabel: CHART_THEME.axisLabel
                },
                yAxis: {
                    type: 'value',
                    name: 'äº¿å…ƒ',
                    splitLine: CHART_THEME.splitLine
                },
                series: [{
                    name: 'GDP',
                    data: gdpData,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    lineStyle: { color: CHART_THEME.colors[0], width: 3 },
                    itemStyle: { color: CHART_THEME.colors[0] },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(30, 58, 138, 0.2)' },
                            { offset: 1, color: 'rgba(30, 58, 138, 0)' }
                        ])
                    }
                }]
            });
            
            // --- 2. äº§ä¸šç»“æ„é¥¼å›¾ (ä¿æŒä¸å˜) ---
            if (latest && latest.GDP_Primary && latest.GDP_Secondary && latest.GDP_Tertiary) {
                const structureChart = echarts.init(document.getElementById('economy-structure-chart'));
                structureChart.setOption({
                    ...CHART_THEME,
                    tooltip: { trigger: 'item', ...CHART_THEME.tooltip },
                    legend: { orient: 'vertical', right: 0, top: 'center', textStyle: CHART_THEME.textStyle },
                    series: [{
                        type: 'pie',
                        radius: ['50%', '70%'],
                        center: ['40%', '50%'],
                        itemStyle: { borderColor: '#fff', borderWidth: 2 },
                        data: [
                            { value: latest.GDP_Primary, name: 'ç¬¬ä¸€äº§ä¸š', itemStyle: { color: '#059669' } }, // ç»¿è‰²ä»£è¡¨å†œä¸š
                            { value: latest.GDP_Secondary, name: 'ç¬¬äºŒäº§ä¸š', itemStyle: { color: '#1e3a8a' } }, // è“è‰²ä»£è¡¨å·¥ä¸š
                            { value: latest.GDP_Tertiary, name: 'ç¬¬ä¸‰äº§ä¸š', itemStyle: { color: '#7c3aed' } }  // ç´«è‰²ä»£è¡¨æœåŠ¡ä¸š
                        ],
                        label: { show: false },
                        emphasis: { label: { show: true, formatter: '{b}\n{d}%' } }
                    }]
                });
            }
            
            // --- 3. æ”¶å…¥æ°´å¹³å¯¹æ¯” (å¸¦æ´å¯Ÿ) ---
            const incomeChart = echarts.init(document.getElementById('economy-income-chart'));
            const urbanWage = data.map(d => d.UrbanAvgWage ? (d.UrbanAvgWage / 1000).toFixed(2) : null);
            const ruralIncome = data.map(d => d.RuralDisposableIncome ? (d.RuralDisposableIncome / 1000).toFixed(2) : null);
            
            // è®¡ç®—åŸä¹¡æ”¶å…¥æ¯” (æœ€æ–°å¹´ä»½)
            let gapText = '';
            if (latest.UrbanAvgWage && latest.RuralDisposableIncome) {
                const gap = (latest.UrbanAvgWage / latest.RuralDisposableIncome).toFixed(2);
                gapText = `åŸä¹¡æ”¶å…¥æ¯”: ${gap}`;
            }

            incomeChart.setOption({
                ...CHART_THEME,
                title: {
                    text: gapText ? `{gap|${gapText}}` : '',
                    right: 0,
                    top: 0,
                    textStyle: {
                        rich: {
                            gap: {
                                backgroundColor: '#f8fafc',
                                color: '#475569',
                                borderRadius: 4,
                                padding: [4, 8],
                                fontSize: 11,
                                borderWidth: 1,
                                borderColor: '#cbd5e1'
                            }
                        }
                    }
                },
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { top: 0, left: 0, textStyle: CHART_THEME.textStyle }, // Legendæ”¾å·¦è¾¹ï¼ŒInsightsæ”¾å³è¾¹
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', name: 'åƒå…ƒ', splitLine: CHART_THEME.splitLine },
                series: [
                    {
                        name: 'åŸé•‡å¹³å‡å·¥èµ„',
                        data: urbanWage,
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: CHART_THEME.colors[0], width: 2 },
                        itemStyle: { color: CHART_THEME.colors[0] }
                    },
                    {
                        name: 'å†œæ‘äººå‡å¯æ”¯é…æ”¶å…¥',
                        data: ruralIncome,
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: CHART_THEME.colors[1], width: 2 },
                        itemStyle: { color: CHART_THEME.colors[1] }
                    }
                ]
            });
            
            // --- 4. è´¢æ”¿æ”¶æ”¯ (ä¿æŒä¸å˜) ---
            const fiscalChart = echarts.init(document.getElementById('economy-fiscal-chart'));
            const revenue = data.map(d => d.FiscalRevenue ? (d.FiscalRevenue / 10000).toFixed(2) : null);
            const expenditure = data.map(d => d.FiscalExpenditure ? (d.FiscalExpenditure / 10000).toFixed(2) : null);
            
            fiscalChart.setOption({
                ...CHART_THEME,
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { top: 0, textStyle: CHART_THEME.textStyle },
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', name: 'äº¿å…ƒ', splitLine: CHART_THEME.splitLine },
                series: [
                    { name: 'è´¢æ”¿æ”¶å…¥', data: revenue, type: 'bar', itemStyle: { color: '#059669' }, barMaxWidth: 20 },
                    { name: 'è´¢æ”¿æ”¯å‡º', data: expenditure, type: 'bar', itemStyle: { color: '#b91c1c' }, barMaxWidth: 20 }
                ]
            });
        }

        // æ¸²æŸ“å†œä¸šå›¾è¡¨ (é€‚é…æ–°æ ·å¼)
        async function renderAgricultureCharts(data, countyCode) {
            const years = data.map(d => d.Year);
            const latest = data[data.length - 1];
            
            // 1. äº§å‡ºè¶‹åŠ¿
            const outputChart = echarts.init(document.getElementById('agriculture-output-chart'));
            const grain = data.map(d => d.GrainOutput ? (d.GrainOutput / 1000).toFixed(2) : null);
            const meat = data.map(d => d.MeatOutput ? (d.MeatOutput / 1000).toFixed(2) : null);
            
            outputChart.setOption({
                ...CHART_THEME,
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { data: ['ç²®é£Ÿäº§é‡', 'è‚‰ç±»äº§é‡'], top: 0 },
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', name: 'åƒå¨', splitLine: CHART_THEME.splitLine },
                series: [
                    { name: 'ç²®é£Ÿäº§é‡', data: grain, type: 'bar', itemStyle: { color: '#d97706' }, stack: 'total' },
                    { name: 'è‚‰ç±»äº§é‡', data: meat, type: 'bar', itemStyle: { color: '#b91c1c' }, stack: 'total' }
                ]
            });
            
            // 2 & 3 (Fetch logic remains same, styling updated via global theme)
            try {
                const cropRes = await fetch(`${API_BASE}/counties/${countyCode}/crops?year=${latest.Year || 2020}`);
                const cropData = await cropRes.json();
                
                if (cropData.success && cropData.data.length > 0) {
                    // Crop Pie Chart
                    const cropChart = echarts.init(document.getElementById('agriculture-crop-chart'));
                    const cropTypes = cropData.data.sort((a, b) => (b.SownArea || 0) - (a.SownArea || 0)).slice(0, 8)
                        .map(d => ({ value: d.SownArea || 0, name: d.CropType }));
                    
                    cropChart.setOption({
                        ...CHART_THEME,
                        tooltip: { trigger: 'item', ...CHART_THEME.tooltip },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            itemStyle: { borderColor: '#fff', borderWidth: 2 },
                            data: cropTypes
                        }]
                    });
                    
                    // Crop Area Bar Chart
                    const areaChart = echarts.init(document.getElementById('agriculture-area-chart'));
                    const topCrops = cropData.data.sort((a, b) => (b.SownArea || 0) - (a.SownArea || 0)).slice(0, 10);
                    
                    areaChart.setOption({
                        ...CHART_THEME,
                        grid: { ...CHART_THEME.grid, left: '15%' },
                        xAxis: { type: 'value', name: 'å…¬é¡·', splitLine: CHART_THEME.splitLine },
                        yAxis: { type: 'category', data: topCrops.map(c => c.CropType), axisLine: CHART_THEME.axisLine },
                        series: [{
                            data: topCrops.map(c => c.SownArea || 0),
                            type: 'bar',
                            itemStyle: { color: '#059669', borderRadius: [0, 4, 4, 0] }
                        }]
                    });
                }
            } catch (error) { console.error(error); }
        }

        // è®¿è°ˆç­›é€‰ä¸åŠ è½½ (æ–°æ ·å¼)
        let interviewFilters = { county_code: '', surveyor_id: '', keyword: '' };

        function openInterviewFilter() {
            const modal = document.getElementById('interview-filter-modal');
            if (modal) {
                modal.style.display = 'flex';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);
            }
        }

        function closeInterviewFilter() {
            const modal = document.getElementById('interview-filter-modal');
            if (modal) {
                modal.style.display = 'none';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
            }
        }

        function applyInterviewFilter() {
            interviewFilters.county_code = document.getElementById('filter-county-code').value.trim();
            interviewFilters.surveyor_id = document.getElementById('filter-surveyor-id').value.trim();
            interviewFilters.keyword = document.getElementById('filter-keyword').value.trim();
            loadInterviews();
            closeInterviewFilter();
        }
        
        function resetInterviewFilter() {
            document.getElementById('filter-county-code').value = '';
            document.getElementById('filter-surveyor-id').value = '';
            document.getElementById('filter-keyword').value = '';
            interviewFilters = { county_code: '', surveyor_id: '', keyword: '' };
            loadInterviews();
            closeInterviewFilter();
        }

        let wordcloudChart = null;

        async function loadWordcloud() {
            try {
                // æ•°æ®æ¦‚è§ˆé¡µé¢çš„è¯äº‘ä¸éœ€è¦ç­›é€‰æ¡ä»¶ï¼Œå±•ç¤ºæ‰€æœ‰è®¿è°ˆçš„å…³é”®è¯
                const params = new URLSearchParams();
                params.append('limit', '50');
                
                const response = await fetch(`${API_BASE}/interviews/wordcloud?${params}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const chartDom = document.getElementById('wordcloud-chart');
                    if (!chartDom) return;
                    
                    if (wordcloudChart) {
                        wordcloudChart.dispose();
                    }
                    wordcloudChart = echarts.init(chartDom);
                    
                    const option = {
                        ...CHART_THEME,
                        series: [{
                            type: 'wordCloud',
                            gridSize: 8,
                            sizeRange: [14, 60],
                            rotationRange: [-45, 45],
                            shape: 'circle',
                            width: '100%',
                            height: '100%',
                            textStyle: {
                                fontFamily: 'Noto Serif SC, serif',
                                fontWeight: 'bold',
                                color: function() {
                                    const colors = ['#1e3a8a', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#6366f1', '#8b5cf6'];
                                    return colors[Math.floor(Math.random() * colors.length)];
                                }
                            },
                            emphasis: {
                                textStyle: {
                                    shadowBlur: 10,
                                    shadowColor: '#333'
                                }
                            },
                            data: result.data
                        }]
                    };
                    
                    wordcloudChart.setOption(option);
                    
                    // ç‚¹å‡»è¯äº‘ä¸­çš„è¯ï¼Œè·³è½¬åˆ°è®¿è°ˆé¡µé¢å¹¶ç­›é€‰
                    wordcloudChart.off('click'); // ç§»é™¤æ—§çš„ç›‘å¬å™¨
                    wordcloudChart.on('click', function(params) {
                        // è·³è½¬åˆ°è®¿è°ˆé¡µé¢ï¼ˆSection 5ï¼‰
                        if (typeof fullpage_api !== 'undefined') {
                            fullpage_api.moveTo(5);
                            setTimeout(() => {
                                // è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶åŠ è½½è®¿è°ˆ
                                interviewFilters.keyword = params.name;
                                interviewFilters.county_code = '';
                                interviewFilters.surveyor_id = '';
                                document.getElementById('interview-search').value = params.name;
                                loadInterviews();
                            }, 500);
                        }
                    });
                } else {
                    const chartDom = document.getElementById('wordcloud-chart');
                    if (chartDom) {
                        chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 text-sm">æš‚æ— æ•°æ®</div>';
                    }
                }
            } catch (error) {
                console.error('Wordcloud load error:', error);
            }
        }

        async function loadInterviews(quickKeyword = '') {
            try {
                const params = new URLSearchParams();
                if (quickKeyword) params.append('keyword', quickKeyword);
                else {
                    if (interviewFilters.county_code) params.append('county_code', interviewFilters.county_code);
                    if (interviewFilters.surveyor_id) params.append('surveyor_id', interviewFilters.surveyor_id);
                    if (interviewFilters.keyword) params.append('keyword', interviewFilters.keyword);
                }
                params.append('limit', '20');
                
                const response = await fetch(`${API_BASE}/interviews?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('interviews-container');
                    if (result.data.length === 0) {
                        container.innerHTML = '<div class="text-center py-8 text-slate-400">æš‚æ— è®¿è°ˆè®°å½•</div>';
                        return;
                    }
                    
                    // æ™ºåº“é£ï¼šè®¿è°ˆåƒå¡ç‰‡/å¼•ç”¨
                    container.innerHTML = result.data.map(interview => {
                        const date = interview.InterviewDate ? new Date(interview.InterviewDate).toLocaleDateString('zh-CN') : '';
                        return `
                            <div class="report-card bg-white rounded-lg p-5 relative overflow-hidden mb-4">
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-900"></div>
                                <div class="flex justify-between items-start mb-2 pl-3">
                                    <div>
                                        <div class="font-bold text-lg text-slate-800 font-serif flex items-center">
                                            ${interview.IntervieweeName || 'åŒ¿åå—è®¿è€…'}
                                            <span class="ml-2 text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">${interview.CountyName}</span>
                                        </div>
                                        <div class="text-xs text-slate-400 mt-1">
                                            ${date} ${interview.SurveyorName ? ' Â· è°ƒç ”å‘˜: ' + interview.SurveyorName : ''}
                                        </div>
                                    </div>
                                    ${interview.Quality ? `<div class="text-amber-500 text-sm"><i class="fas fa-star"></i> ${interview.Quality}</div>` : ''}
                                </div>
                                <div class="pl-3 pt-2 relative mt-2 border-t border-slate-50">
                                    <i class="fas fa-quote-left absolute -left-0 -top-2 text-slate-100 text-3xl z-0"></i>
                                    <div class="text-slate-600 text-sm leading-relaxed relative z-10 font-serif italic">
                                        ${interview.Content ? interview.Content.substring(0, 300) + (interview.Content.length > 300 ? '...' : '') : 'æš‚æ— è®°å½•å†…å®¹'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) { console.error(error); }
        }

        // å¯¹æ¯”åˆ†æé€»è¾‘
        let selectedCountiesForCompare = [];

        async function openCountySelector() {
            const modal = document.getElementById('county-selector-modal');
            if (modal) {
                modal.style.display = 'flex';
                await loadSelectorProvinces();
                loadCountySelectorList();
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);
            }
        }
        
        function closeCountySelector() {
            const modal = document.getElementById('county-selector-modal');
            if (modal) {
                modal.style.display = 'none';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
            }
        }

        async function loadSelectorProvinces() {
            try {
                const response = await fetch(`${API_BASE}/counties`);
                const result = await response.json();
                if (result.success) {
                    const provinces = [...new Set(result.data.filter(c => c.Province).map(c => c.Province))].sort();
                    const select = document.getElementById('selector-province');
                    if (select) {
                        select.innerHTML = '<option value="">å…¨éƒ¨çœä»½</option>';
                        provinces.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
                    }
                }
            } catch(e) {}
        }

        async function loadCountySelectorList(filters = {}) {
            try {
                const params = new URLSearchParams();
                if (filters.region) params.append('region', filters.region);
                if (filters.province) params.append('province', filters.province);
                const response = await fetch(`${API_BASE}/counties?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('county-selector-list');
                    const validCounties = result.data.filter(c => c.CountyName && !c.CountyName.startsWith('å¿ä»£ç '));
                    const keyword = document.getElementById('selector-search')?.value.trim().toLowerCase();
                    const filtered = keyword ? validCounties.filter(c => c.CountyName.includes(keyword)) : validCounties;
                    
                    container.innerHTML = filtered.map(county => {
                        const isSelected = selectedCountiesForCompare.some(sc => sc.CountyCode === county.CountyCode);
                        return `
                            <div class="bg-white border ${isSelected ? 'border-blue-600 ring-1 ring-blue-600 bg-blue-50' : 'border-slate-200'} rounded p-3 cursor-pointer hover:border-blue-400 transition-all" 
                                 onclick="toggleCountySelection('${county.CountyCode}', '${county.CountyName}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold text-slate-800">${county.CountyName}</div>
                                        <div class="text-xs text-slate-500">${county.Province || ''}</div>
                                    </div>
                                    ${isSelected ? '<i class="fas fa-check-circle text-blue-600"></i>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch(e) {}
        }

        function toggleCountySelection(code, name) {
            const idx = selectedCountiesForCompare.findIndex(c => c.CountyCode === code);
            if (idx >= 0) selectedCountiesForCompare.splice(idx, 1);
            else {
                if (selectedCountiesForCompare.length >= 5) { alert('æœ€å¤šé€‰æ‹©5ä¸ª'); return; }
                selectedCountiesForCompare.push({ CountyCode: code, CountyName: name });
            }
            loadCountySelectorList();
            updateSelectedCountiesDisplay();
        }

        function updateSelectedCountiesDisplay() {
            const container = document.getElementById('selected-counties');
            if (selectedCountiesForCompare.length === 0) container.innerHTML = '<div class="text-sm text-slate-400 italic self-center">æš‚æœªé€‰æ‹©å¿åŸŸ</div>';
            else {
                container.innerHTML = selectedCountiesForCompare.map(c => `
                    <div class="bg-blue-100 text-blue-800 border border-blue-200 rounded px-3 py-1 flex items-center gap-2 text-sm font-medium">
                        <span>${c.CountyName}</span>
                        <button onclick="removeSelectedCounty('${c.CountyCode}')" class="hover:text-blue-900"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            }
        }

        function removeSelectedCounty(code) {
            selectedCountiesForCompare = selectedCountiesForCompare.filter(c => c.CountyCode !== code);
            updateSelectedCountiesDisplay();
        }

        function applyCountySelection() {
            closeCountySelector();
            if (selectedCountiesForCompare.length >= 2) loadCompareData();
        }

        async function loadCompareData() {
            let codes = selectedCountiesForCompare.length > 0 
                ? selectedCountiesForCompare.map(c => c.CountyCode)
                : document.getElementById('compare-input').value.split(',').map(c => c.trim()).filter(c => c);
                
            if (codes.length < 2) { alert('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ ·æœ¬'); return; }
            
            const metric = document.getElementById('compare-metric').value;
            const type = document.getElementById('compare-chart-type').value;
            
            try {
                const params = new URLSearchParams();
                codes.forEach(c => params.append('county_code', c));
                params.append('metric', metric);
                params.append('start_year', '2010');
                params.append('end_year', '2020');
                
                const response = await fetch(`${API_BASE}/compare/trend?${params}`);
                const result = await response.json();
                if (result.success) renderCompareChart(result.data, metric, type);
            } catch(e) { console.error(e); }
        }

        function renderCompareChart(data, metric, chartType) {
            // 1. æ¸²æŸ“å·¦ä¾§è¶‹åŠ¿å›¾ (æŠ˜çº¿/æŸ±çŠ¶/é¢ç§¯)
            const chart = echarts.init(document.getElementById('compare-chart'));
            const years = [...new Set(data.map(d => d.Year))].sort();
            const countyMap = {};
            
            // æ•°æ®åˆ†ç»„å¤„ç†
            data.forEach(d => {
                if (!countyMap[d.CountyCode]) countyMap[d.CountyCode] = { name: d.CountyName, data: [] };
                countyMap[d.CountyCode].data.push([d.Year, d[metric] || d.GDP || 0]);
            });
            
            // æ„å»ºå·¦ä¾§å›¾è¡¨ Series
            const series = Object.values(countyMap).map((c, idx) => ({
                name: c.name,
                type: chartType === 'area' ? 'line' : chartType,
                data: years.map(y => {
                    const pt = c.data.find(p => p[0] === y);
                    // ç®€å•å•ä½æ¢ç®—ï¼šå¦‚æœæ˜¯å¤§é¢æ•°æ®é™¤ä»¥10000
                    const val = pt ? pt[1] : 0;
                    return ['GDP','AgriOutputValue','FiscalRevenue','FiscalExpenditure','IndustrialOutput','RetailSales'].includes(metric) ? parseFloat((val/10000).toFixed(2)) : val;
                }),
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                // é¢ç§¯å›¾æ ·å¼ç‰¹æ®Šå¤„ç†
                areaStyle: chartType === 'area' ? { opacity: 0.3 } : null,
                itemStyle: { color: CHART_THEME.colors[idx % CHART_THEME.colors.length] },
                lineStyle: { width: 3 }
            }));
            
            chart.setOption({
                ...CHART_THEME,
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { top: 0, textStyle: CHART_THEME.textStyle },
                grid: { ...CHART_THEME.grid, right: '5%' }, // è°ƒæ•´è¾¹è·
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', splitLine: CHART_THEME.splitLine },
                series: series
            });
            
            // ==========================================
            // 2. è¡¥å…¨ï¼šæ¸²æŸ“å³ä¾§é¥¼å›¾ (æœ€æ–°å¹´ä»½å æ¯”)
            // ==========================================
            const pieChart = echarts.init(document.getElementById('compare-pie-chart'));
            
            // è·å–æœ€æ–°å¹´ä»½çš„æ•°æ®ç”¨äºç”»é¥¼
            const latestYear = years[years.length - 1];
            const latestData = data.filter(d => d.Year === latestYear);
            
            if (latestData.length > 0) {
                const pieSeriesData = latestData.map((d, idx) => {
                    let val = d[metric] || d.GDP || 0;
                    // ä¿æŒå’Œå·¦å›¾ä¸€æ ·çš„å•ä½æ¢ç®—é€»è¾‘
                    if (['GDP','AgriOutputValue','FiscalRevenue','FiscalExpenditure','IndustrialOutput','RetailSales'].includes(metric)) {
                        val = parseFloat((val/10000).toFixed(2));
                    }
                    return {
                        value: val,
                        name: d.CountyName,
                        itemStyle: { color: CHART_THEME.colors[idx % CHART_THEME.colors.length] }
                    };
                });

                pieChart.setOption({
                    ...CHART_THEME,
                    title: {
                        text: `${latestYear}å¹´ å æ¯”å¯¹æ¯”`, // åŠ¨æ€æ ‡é¢˜
                        left: 'center',
                        top: 20,
                        textStyle: { fontSize: 16, color: '#334155', fontFamily: 'Noto Serif SC' }
                    },
                    tooltip: { 
                        trigger: 'item', 
                        ...CHART_THEME.tooltip,
                        formatter: '{b}: {c} ({d}%)' // æ˜¾ç¤ºæ•°å€¼å’Œç™¾åˆ†æ¯”
                    },
                    legend: {
                        bottom: 10,
                        left: 'center',
                        textStyle: CHART_THEME.textStyle
                    },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '65%'], // ç”œç”œåœˆå½¢çŠ¶æ›´ç°ä»£
                        center: ['50%', '55%'],
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 3
                        },
                        label: {
                            show: true,
                            formatter: '{b}\n{d}%',
                            color: '#64748b'
                        },
                        data: pieSeriesData
                    }]
                });
            } else {
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ¸…ç©ºå›¾è¡¨
                pieChart.clear();
            }
        }

        // äº‹ä»¶ç›‘å¬ç»‘å®š
        document.getElementById('region-filter')?.addEventListener('change', e => loadCounties({ region: e.target.value, province: document.getElementById('province-filter').value }));
        document.getElementById('province-filter')?.addEventListener('change', e => loadCounties({ region: document.getElementById('region-filter').value, province: e.target.value }));
        document.getElementById('search-input')?.addEventListener('input', e => {
            const kw = e.target.value.toLowerCase();
            document.querySelectorAll('#counties-container > div').forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(kw) ? '' : 'none';
            });
        });
        
        // æ¨¡æ€æ¡†ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.querySelectorAll('.modal-backdrop').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) modal.style.display = 'none';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
            });
        });

        document.getElementById('interview-search')?.addEventListener('input', (e) => {
            const keyword = e.target.value.trim();
            if (keyword) loadInterviews(keyword);
            else loadInterviews();
        });
        
        document.getElementById('selector-region')?.addEventListener('change', e => loadCountySelectorList({ region: e.target.value, province: document.getElementById('selector-province').value }));
        document.getElementById('selector-province')?.addEventListener('change', e => loadCountySelectorList({ region: document.getElementById('selector-region').value, province: e.target.value }));
        document.getElementById('selector-search')?.addEventListener('input', () => loadCountySelectorList());

        // è°ƒç ”å‘˜æœç´¢è¾“å…¥æ¡†å›è½¦é”®ç›‘å¬
        document.getElementById('surveyor-search')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadSurveyors();
            }
        });

        async function loadSurveyors(options = {}) {
            const keyword = document.getElementById('surveyor-search')?.value || '';
            const county_code = document.getElementById('surveyor-county-code')?.value || '';
            
            try {
                const params = new URLSearchParams();
                if (keyword) params.append('keyword', keyword);
                if (county_code) params.append('county_code', county_code);
                
                const res = await fetch(`${API_BASE}/surveyors?${params}`);
                const { data } = await res.json();
                
                const container = document.getElementById('surveyors-container');
                if (!container) return;
                
                container.innerHTML = data.map(s => `
                    <div class="report-card bg-white p-6 rounded-xl shadow-sm cursor-pointer hover:shadow-md transition group" onclick='openSurveyorDetail(${JSON.stringify(s)})'>
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors">
                                ${s.Name.charAt(0)}
                            </div>
                            <span class="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded uppercase">${s.SurveyorID}</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1">${s.Name}</h3>
                        <p class="text-sm text-blue-600 font-medium mb-3">${s.Role || 'è°ƒç ”å‘˜'}</p>
                        
                        <div class="space-y-2 text-sm text-slate-500">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt w-4 text-center text-slate-400"></i>
                                <span class="truncate">${s.CountyName || 'æœªåˆ†é…'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check-circle w-4 text-center text-slate-400"></i>
                                <span>å·²è®¿è°ˆ: <span class="font-bold text-slate-700">${s.CompletedInterviews}</span></span>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Load stats
                const statsRes = await fetch(`${API_BASE}/surveyors/stats`);
                const stats = (await statsRes.json()).data;
                const statsBar = document.getElementById('surveyor-stats-bar');
                if (statsBar && stats) {
                    statsBar.innerHTML = `
                        <div><span class="font-bold text-slate-800">${stats.total_surveyors}</span> åæˆå‘˜</div>
                        <div><span class="font-bold text-slate-800">${stats.total_teams}</span> ä¸ªåˆ†é˜Ÿ</div>
                        <div><span class="font-bold text-slate-800">${stats.covered_counties}</span> ä¸ªè¦†ç›–å¿</div>
                        <div>ç´¯è®¡è®¿è°ˆ <span class="font-bold text-blue-600">${stats.total_interviews}</span> æ¬¡</div>
                    `;
                }
            } catch (e) {
                console.error(e);
            }
        }

        function openSurveyorDetail(s) {
            currentSurveyorID = s.SurveyorID; // ä¿å­˜å½“å‰è°ƒç ”å‘˜ID
            
            document.getElementById('detail-avatar').textContent = s.Name.charAt(0);
            document.getElementById('detail-name').textContent = s.Name;
            document.getElementById('detail-id').textContent = s.SurveyorID;
            document.getElementById('detail-team').textContent = s.TeamID || 'æœªåˆ†é…';
            document.getElementById('detail-role').textContent = s.Role || 'æœªçŸ¥';
            document.getElementById('detail-edu').textContent = `${s.Education || ''} ${s.Major || ''}`;
            document.getElementById('detail-dept').textContent = s.Department || '--';
            document.getElementById('detail-county-code').textContent = s.CountyCode || 'N/A';
            document.getElementById('detail-county-name').textContent = s.CountyName || 'æœªåˆ†é…è´Ÿè´£å¿åŸŸ';
            document.getElementById('detail-expertise').textContent = s.Expertise || 'æš‚æ— ä¸“é•¿æè¿°';
            document.getElementById('detail-notes').textContent = s.Notes || 'æ— å¤‡æ³¨';
            
            // Privacy fields
            const phoneEl = document.getElementById('detail-phone');
            const emailEl = document.getElementById('detail-email');
            
            if (s.Phone) {
                phoneEl.textContent = s.Phone;
                phoneEl.classList.remove('text-slate-400', 'italic');
                phoneEl.classList.add('text-slate-700', 'font-mono');
            } else {
                phoneEl.textContent = '*********** (æ— æƒé™æŸ¥çœ‹)';
                phoneEl.classList.add('text-slate-400', 'italic');
                phoneEl.classList.remove('text-slate-700', 'font-mono');
            }

            if (s.Email) {
                emailEl.textContent = s.Email;
                emailEl.classList.remove('text-slate-400', 'italic');
                emailEl.classList.add('text-slate-700', 'font-mono');
            } else {
                emailEl.textContent = '*********** (æ— æƒé™æŸ¥çœ‹)';
                emailEl.classList.add('text-slate-400', 'italic');
                emailEl.classList.remove('text-slate-700', 'font-mono');
            }

            const modal = document.getElementById('surveyor-detail-modal');
            modal.style.display = 'flex';
            if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);
        }

        function closeSurveyorDetail() {
            const modal = document.getElementById('surveyor-detail-modal');
            modal.style.display = 'none';
            if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
        }

        let currentSurveyorID = null; // å­˜å‚¨å½“å‰æŸ¥çœ‹çš„è°ƒç ”å‘˜ID

        function viewSurveyorInterviews() {
            if (!currentSurveyorID) return;
            
            // è®¾ç½®ç­›é€‰æ¡ä»¶
            interviewFilters.surveyor_id = currentSurveyorID;
            interviewFilters.county_code = '';
            interviewFilters.keyword = '';
            
            // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
            closeSurveyorDetail();
            
            // è·³è½¬åˆ°è®¿è°ˆè®°å½•é¡µé¢ï¼ˆSection 5ï¼‰å¹¶åŠ è½½æ•°æ®
            if (typeof fullpage_api !== 'undefined') {
                fullpage_api.moveTo(5);
                setTimeout(() => {
                    loadInterviews();
                }, 500); // ç­‰å¾…é¡µé¢æ»šåŠ¨å®Œæˆåå†åŠ è½½æ•°æ®
            } else {
                loadInterviews();
            }
        }

        // ç›‘å¬å›¾è¡¨ç±»å‹å˜åŒ–
        document.getElementById('compare-metric')?.addEventListener('change', () => { if(selectedCountiesForCompare.length>=2) loadCompareData(); });
        document.getElementById('compare-chart-type')?.addEventListener('change', () => { if(selectedCountiesForCompare.length>=2) loadCompareData(); });

        setTimeout(loadInterviews, 1000);
        setTimeout(loadSurveyors, 1000); // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è°ƒç ”å‘˜åˆ—è¡¨

        // å¯¼å‡ºåŠŸèƒ½
        async function exportCounties() {
            try {
                const region = document.getElementById('region-filter')?.value || '';
                const exitYear = document.getElementById('exit-year-filter')?.value || '';
                
                const params = new URLSearchParams();
                if (region) params.append('region', region);
                if (exitYear) params.append('exit_year', exitYear);
                
                const url = `${API_BASE}/export/counties${params.toString() ? '?' + params.toString() : ''}`;
                
                // ä½¿ç”¨fetchä¸‹è½½æ–‡ä»¶
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('å¯¼å‡ºå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `counties_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
            } catch (e) {
                console.error('Export error:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }

        async function exportInterviews() {
            try {
                const countyCode = interviewFilters?.county_code || '';
                const surveyorID = interviewFilters?.surveyor_id || '';
                
                const params = new URLSearchParams();
                if (countyCode) params.append('county_code', countyCode);
                if (surveyorID) params.append('surveyor_id', surveyorID);
                
                const url = `${API_BASE}/export/interviews${params.toString() ? '?' + params.toString() : ''}`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('å¯¼å‡ºå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `interviews_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
            } catch (e) {
                console.error('Export error:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }

        async function exportSurveyors() {
            try {
                const url = `${API_BASE}/export/surveyors`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('å¯¼å‡ºå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `surveyors_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
            } catch (e) {
                console.error('Export error:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
    </script>
</body>
</html>