<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>832工程 - 中国脱贫攻坚案例库</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Serif+SC:wght@400;600;700;900&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/fullpage.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/fullpage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/vendors/scrolloverflow.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        :root {
            --theme-blue: #1e3a8a;   /* blue-900 */
            --theme-red: #b91c1c;    /* red-700 */
            --theme-text: #1e293b;   /* slate-800 */
            --theme-sub: #64748b;    /* slate-500 */
            --card-bg: #ffffff;
            --card-border: #e2e8f0;  /* slate-200 */
        }

        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* 标题使用宋体/衬线体 */
        h1, h2, h3, h4, .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* 政务风背景 - 极淡的冷色调 */
        .section-bg-hero {
            background: radial-gradient(circle at 50% 50%, #eff6ff 0%, #f8fafc 100%);
        }
        
        .section-bg-light {
            background-color: #f8fafc; /* slate-50 */
        }

        .section-bg-alt {
            background-color: #f1f5f9; /* slate-100 */
        }
        
        /* 核心数字 - 实心深色，更有分量感 */
        .hero-number {
            font-size: 10rem;
            font-weight: 900;
            line-height: 1;
            color: var(--theme-blue);
            letter-spacing: -0.05em;
            position: relative;
            display: inline-block;
        }
        /* 红色装饰点 */
        .hero-number::after {
            content: '.';
            color: var(--theme-red);
        }
        
        .section-title {
            font-size: 3.5rem;
            font-weight: 900;
            color: #0f172a; /* slate-900 */
            letter-spacing: -0.02em;
        }
        
        .section-subtitle {
            font-size: 1rem;
            color: var(--theme-sub);
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        /* 智库报告卡片风格 */
        .report-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-out;
        }
        
        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            border-color: #cbd5e1;
        }
        
        /* 通用输入框样式 - 白底灰边 */
        .input-standard {
            background-color: #fff;
            border: 1px solid #cbd5e1;
            color: #334155;
            transition: all 0.2s;
        }
        .input-standard:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        .input-standard::placeholder {
            color: #94a3b8;
        }
        
        .parallax-element {
            transition: transform 0.3s ease-out;
        }
        
        /* FullPage 导航点颜色修正 */
        #fp-nav ul li a span {
            background: #94a3b8 !important;
        }
        #fp-nav ul li a.active span {
            background: #1e3a8a !important;
            width: 12px;
            height: 12px;
            margin: -6px 0 0 -6px;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 模态框样式调整 */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6); /* 深色半透明背景 */
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #ffffff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">
    <div id="fullpage">
        <div class="section section-bg-hero">
            <div class="flex items-center justify-center h-screen">
                <div class="text-center px-8 max-w-5xl">
                    <div class="mb-8 parallax-element" data-speed="0.5">
                         <div class="hero-number">832</div>
                    </div>
                    
                    <div class="inline-flex items-center px-3 py-1 rounded-full border border-red-200 bg-red-50 text-red-800 text-xs font-bold tracking-widest mb-6">
                        <span class="w-2 h-2 rounded-full bg-red-600 mr-2"></span>
                        国家级贫困县全名单数据档案
                    </div>
                    
                    <h1 class="text-5xl md:text-6xl font-black mb-6 text-slate-900 tracking-tight">中国脱贫攻坚案例库</h1>
                    <p class="text-xl text-slate-500 mb-12 mono max-w-2xl mx-auto leading-relaxed">
                        POVERTY ALLEVIATION CASE LIBRARY<br>
                        <span class="text-base font-sans mt-2 block opacity-80">基于多维数据的县域经济发展回顾与乡村振兴路径探索</span>
                    </p>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="fullpage_api.moveTo(2)" class="px-8 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded shadow-lg hover:shadow-xl font-medium transition flex items-center transform hover:-translate-y-1">
                            <i class="fas fa-database mr-2 text-sm"></i> 探索数据
                        </button>
                        <button onclick="fullpage_api.moveTo(3)" class="px-8 py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded shadow hover:shadow-md font-medium transition flex items-center">
                            <i class="fas fa-chart-line mr-2 text-sm"></i> 县域分析
                        </button>
                    </div>
                    
                    <div class="absolute bottom-8 left-0 right-0 text-center text-slate-400 text-xs uppercase tracking-widest">
                        Authorized Data Visualization System
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-light">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-6xl w-full">
                    <div class="text-center mb-12">
                        <h2 class="section-title">数据概览</h2>
                        <p class="section-subtitle">Overview Statistics</p>
                    </div>
                    <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-alt">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-7xl w-full">
                    <div class="mb-8">
                        <h2 class="section-title text-4xl mb-2">县域探索</h2>
                        <p class="section-subtitle">County Exploration</p>
                    </div>
                    
                    <div class="mb-6 flex gap-4 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <select id="region-filter" class="px-4 py-2 input-standard rounded-md w-32">
                            <option value="">全部地区</option>
                            <option value="东部">东部</option>
                            <option value="中部">中部</option>
                            <option value="西部">西部</option>
                        </select>
                        <select id="province-filter" class="px-4 py-2 input-standard rounded-md w-32">
                            <option value="">全部省份</option>
                        </select>
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="输入县名搜索..." class="w-full pl-10 px-4 py-2 input-standard rounded-md">
                        </div>
                    </div>
                    
                    <div id="counties-container" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4" style="max-height: 60vh; overflow-y: auto; padding: 2px;">
                        </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-light fp-auto-height">
            <div class="flex items-center justify-center min-h-screen px-8">
                <div id="county-detail-content" class="max-w-7xl w-full py-12 overflow-y-auto" style="max-height: 100vh;">
                    <div class="flex items-end justify-between mb-10 border-b border-slate-200 pb-6">
                        <div>
                            <h2 class="section-title text-4xl mb-2" id="county-detail-title">县域详情</h2>
                            <p class="section-subtitle">County Detail Report</p>
                        </div>
                        <button onclick="fullpage_api.moveTo(3)" class="text-slate-500 hover:text-blue-700 transition">
                            <i class="fas fa-arrow-left mr-1"></i> 返回列表
                        </button>
                    </div>
                    
                    <div class="mb-12">
                        <div class="flex items-center mb-6">
                            <div class="w-1 h-8 bg-blue-800 mr-3 rounded-full"></div>
                            <h3 class="text-2xl font-bold text-slate-800 font-serif">经济数据分析</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">GDP 增长趋势</h4>
                                <div id="economy-gdp-chart" style="height: 300px;"></div>
                            </div>
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">产业结构占比</h4>
                                <div id="economy-structure-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">城乡收入水平</h4>
                                <div id="economy-income-chart" style="height: 300px;"></div>
                            </div>
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">财政收支情况</h4>
                                <div id="economy-fiscal-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <div class="flex items-center mb-6">
                            <div class="w-1 h-8 bg-green-700 mr-3 rounded-full"></div>
                            <h3 class="text-2xl font-bold text-slate-800 font-serif">农业数据分析</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">农业产出规模</h4>
                                <div id="agriculture-output-chart" style="height: 300px;"></div>
                            </div>
                            <div class="report-card rounded-xl p-6 bg-white">
                                <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">农作物种植结构</h4>
                                <div id="agriculture-crop-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <h4 class="text-lg font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">主要农作物面积趋势</h4>
                            <div id="agriculture-area-chart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-alt">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-5xl w-full">
                    <div class="text-center mb-8">
                        <h2 class="section-title text-4xl">田野访谈</h2>
                        <p class="section-subtitle">Field Interview Records</p>
                    </div>
                    
                    <div class="mb-6 flex gap-4">
                        <button onclick="openInterviewFilter()" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-sm transition">
                            <i class="fas fa-filter mr-2"></i> 高级筛选
                        </button>
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            <input type="text" id="interview-search" placeholder="搜索访谈内容关键词..." class="w-full pl-10 px-4 py-2 input-standard rounded-md">
                        </div>
                    </div>
                    
                    <div id="interviews-container" class="space-y-4 pr-2" style="max-height: 60vh; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
        
        <div class="section section-bg-light">
            <div class="flex items-center justify-center h-screen px-8">
                <div class="max-w-7xl w-full">
                    <div class="mb-6">
                        <h2 class="section-title text-4xl mb-2">对比分析</h2>
                        <p class="section-subtitle">Comparative Analysis</p>
                    </div>
                    
                    <div class="report-card bg-white p-6 rounded-xl mb-6">
                        <div class="flex gap-4 mb-4">
                            <button onclick="openCountySelector()" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-sm transition">
                                <i class="fas fa-plus mr-2"></i> 添加对比县
                            </button>
                            <input type="text" id="compare-input" placeholder="或输入代码，逗号分隔（如：130125,410526）" class="flex-1 px-4 py-2 input-standard rounded-md">
                            <button onclick="loadCompareData()" class="px-6 py-2 bg-purple-700 hover:bg-purple-800 text-white rounded-md font-semibold shadow-sm transition">
                                <i class="fas fa-chart-bar mr-2"></i> 生成图表
                            </button>
                        </div>
                        
                        <div id="selected-counties" class="flex flex-wrap gap-2 mb-4 min-h-[40px]">
                            <div class="text-sm text-slate-400 italic self-center">暂未选择县域</div>
                        </div>
                        
                        <div class="flex gap-4 flex-wrap">
                            <select id="compare-metric" class="px-4 py-2 input-standard rounded-md flex-1">
                                <option value="GDP">GDP (地区生产总值)</option>
                                <option value="PerCapitaGDP">人均GDP</option>
                                <option value="RuralDisposableIncome">农村人均可支配收入</option>
                                <option value="AgriOutputValue">农业总产值</option>
                                <option value="FiscalRevenue">财政收入</option>
                                <option value="FiscalExpenditure">财政支出</option>
                                <option value="GrainOutput">粮食产量</option>
                                <option value="MeatOutput">肉类产量</option>
                            </select>
                            <select id="compare-chart-type" class="px-4 py-2 input-standard rounded-md w-40">
                                <option value="line">折线图</option>
                                <option value="bar">柱状图</option>
                                <option value="area">面积图</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="compare-chart-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="report-card bg-white p-4 rounded-xl shadow-sm">
                            <div id="compare-chart" style="height: 400px;"></div>
                        </div>
                        <div class="report-card bg-white p-4 rounded-xl shadow-sm">
                            <div id="compare-pie-chart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="county-selector-modal" class="modal-backdrop fixed inset-0 z-[9999]" style="display: none;">
        <div class="flex items-center justify-center h-full w-full p-4">
            <div class="modal-content rounded-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                    <h3 class="text-2xl font-bold font-serif text-slate-800">选择对比样本</h3>
                    <button onclick="closeCountySelector()" class="text-slate-400 hover:text-slate-700 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="mb-4 flex gap-4">
                    <select id="selector-region" class="px-4 py-2 input-standard rounded-md">
                        <option value="">全部地区</option>
                        <option value="东部">东部</option>
                        <option value="中部">中部</option>
                        <option value="西部">西部</option>
                    </select>
                    <select id="selector-province" class="px-4 py-2 input-standard rounded-md">
                        <option value="">全部省份</option>
                    </select>
                    <input type="text" id="selector-search" placeholder="搜索县名..." class="flex-1 px-4 py-2 input-standard rounded-md">
                </div>
                <div id="county-selector-list" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6" style="max-height: 40vh; overflow-y: auto;">
                    </div>
                <div class="flex gap-4 pt-4 border-t border-slate-100">
                    <button onclick="applyCountySelection()" class="flex-1 px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-md transition">
                        <i class="fas fa-check mr-2"></i> 确认选择
                    </button>
                    <button onclick="closeCountySelector()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md font-semibold transition">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="interview-filter-modal" class="modal-backdrop fixed inset-0 z-[9999]" style="display: none;">
        <div class="flex items-center justify-center h-full w-full p-4">
            <div class="modal-content rounded-xl p-8 max-w-lg w-full relative">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                    <h3 class="text-2xl font-bold font-serif text-slate-800">访谈筛选</h3>
                    <button onclick="closeInterviewFilter()" class="text-slate-400 hover:text-slate-700 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">县代码</label>
                        <input type="text" id="filter-county-code" placeholder="如：130125" class="w-full px-4 py-2 input-standard rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">调研员ID</label>
                        <input type="text" id="filter-surveyor-id" placeholder="如：DY20210002" class="w-full px-4 py-2 input-standard rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">关键词</label>
                        <input type="text" id="filter-keyword" placeholder="内容或受访人姓名" class="w-full px-4 py-2 input-standard rounded-md">
                    </div>
                    <div class="flex gap-4 pt-6">
                        <button onclick="applyInterviewFilter()" class="flex-1 px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white rounded-md font-semibold shadow-md transition">
                            <i class="fas fa-search mr-2"></i> 应用
                        </button>
                        <button onclick="resetInterviewFilter()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md font-semibold transition">
                            重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        /**
         * 智库风 App Logic
         * 整合了原 app.js 并修改了渲染逻辑以适配新风格
         */

        // API基础URL
        const API_BASE = 'http://localhost:5001/api';

        // 全局图表主题配置 (Light Mode / Think Tank Style)
        const CHART_THEME = {
            textStyle: { fontFamily: 'Inter, sans-serif', color: '#475569' }, // slate-600
            title: { textStyle: { color: '#1e293b', fontFamily: 'Noto Serif SC, serif', fontWeight: 'bold' } },
            grid: { left: '10%', right: '5%', top: '15%', bottom: '10%', containLabel: true },
            axisLine: { lineStyle: { color: '#cbd5e1' } }, // slate-300
            axisLabel: { color: '#64748b' }, // slate-500
            splitLine: { lineStyle: { color: '#f1f5f9', type: 'dashed' } }, // slate-100
            // 配色方案：深蓝, 翠绿, 琥珀, 深红, 紫
            colors: ['#1e3a8a', '#059669', '#d97706', '#b91c1c', '#7c3aed'],
            backgroundColor: 'transparent',
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                borderWidth: 1,
                textStyle: { color: '#1e293b' },
                extraCssText: 'box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);'
            }
        };

        // 初始化FullPage.js
        let fullpage_api;
        document.addEventListener('DOMContentLoaded', function() {
            fullpage_api = new fullpage('#fullpage', {
                licenseKey: 'gplv3-license',
                navigation: true,
                navigationPosition: 'right',
                scrollingSpeed: 700,
                parallax: true,
                scrollOverflow: true,
                scrollOverflowOptions: {
                    scrollbars: true,
                    mouseWheel: true,
                    hideScrollbars: false,
                    fadeScrollbars: false
                },
                normalScrollElements: '#county-detail-content, #counties-container, #interviews-container, #county-selector-list',
                onLeave: function(origin, destination, direction) {
                    const parallaxElements = destination.item.querySelectorAll('.parallax-element');
                    parallaxElements.forEach(el => {
                        el.style.transform = 'translateY(0)';
                    });
                }
            });
            
            // 加载初始数据
            loadOverviewStats();
            loadProvinces();
            loadCounties();
        });

        // 加载概览统计 (新样式)
        async function loadOverviewStats() {
            try {
                const response = await fetch(`${API_BASE}/stats/overview`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    const container = document.getElementById('stats-container');
                    
                    container.innerHTML = `
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">贫困县总数</div>
                                    <div class="text-5xl font-black text-slate-800">${stats.poverty_counties}</div>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-full text-blue-700"><i class="fas fa-map-marker-alt"></i></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">已摘帽县数</div>
                                    <div class="text-5xl font-black text-green-700">${stats.exited_counties}</div>
                                </div>
                                <div class="p-3 bg-green-50 rounded-full text-green-700"><i class="fas fa-check-circle"></i></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">访谈实录</div>
                                    <div class="text-5xl font-black text-slate-800">${stats.interviews}</div>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-full text-purple-700"><i class="fas fa-comments"></i></div>
                            </div>
                        </div>
                        <div class="report-card rounded-xl p-6 bg-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">调研人员</div>
                                    <div class="text-5xl font-black text-slate-800">${stats.surveyors}</div>
                                </div>
                                <div class="p-3 bg-orange-50 rounded-full text-orange-600"><i class="fas fa-user-friends"></i></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
                // Fallback UI if API fails
                document.getElementById('stats-container').innerHTML = `<div class="col-span-4 text-center text-slate-400 py-10">无法连接数据服务器 (${API_BASE})</div>`;
            }
        }

        // 加载省份列表
        async function loadProvinces() {
            try {
                const response = await fetch(`${API_BASE}/counties`);
                const result = await response.json();
                
                if (result.success) {
                    const provinces = [...new Set(result.data
                        .filter(c => c.Province && c.Province !== '未知')
                        .map(c => c.Province)
                    )].sort();
                    
                    const select = document.getElementById('province-filter');
                    if (select) {
                        const allOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        if (allOption) select.appendChild(allOption);
                        provinces.forEach(province => {
                            const option = document.createElement('option');
                            option.value = province;
                            option.textContent = province;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) { console.error(error); }
        }

        // 加载县列表 (新样式)
        async function loadCounties(filters = {}) {
            try {
                const params = new URLSearchParams();
                if (filters.region) params.append('region', filters.region);
                if (filters.province) params.append('province', filters.province);
                
                const response = await fetch(`${API_BASE}/counties?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('counties-container');
                    const validCounties = result.data.filter(county => 
                        county.CountyName && !county.CountyName.startsWith('县代码')
                    );
                    
                    validCounties.sort((a, b) => {
                        const aCompleteness = a.DataCompleteness || 0;
                        const bCompleteness = b.DataCompleteness || 0;
                        if (aCompleteness !== bCompleteness) return bCompleteness - aCompleteness;
                        if (a.ExitYear && !b.ExitYear) return -1;
                        if (!a.ExitYear && b.ExitYear) return 1;
                        return (a.CountyName || '').localeCompare(b.CountyName || '');
                    });
                    
                    const counties = validCounties.slice(0, 12);
                    
                    if (counties.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-8 text-slate-400">暂无符合条件的县域数据</div>';
                        return;
                    }
                    
                    container.innerHTML = counties.map(county => `
                        <div class="report-card bg-white rounded-lg p-5 cursor-pointer group hover:border-blue-300" onclick="showCountyDetail('${county.CountyCode}')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-bold text-lg text-slate-800 font-serif group-hover:text-blue-800 transition-colors">
                                    ${county.CountyName || county.CountyCode}
                                </div>
                                ${county.ExitYear ? `<span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs font-bold rounded border border-green-200">摘帽 ${county.ExitYear}</span>` : ''}
                            </div>
                            <div class="text-sm text-slate-500 mb-3 flex items-center">
                                <i class="fas fa-map-marker-alt mr-2 text-slate-300"></i> 
                                ${county.Province || '未知'} · ${county.City || '未知'}
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                                <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">${county.Region || '未知区域'}</span>
                                <span class="text-xs text-blue-600 font-medium opacity-0 group-hover:opacity-100 transition-opacity">查看详情 <i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) { console.error(error); }
        }

        // 显示县详情
        async function showCountyDetail(countyCode) {
            try {
                const countyRes = await fetch(`${API_BASE}/counties/${countyCode}`);
                const countyData = await countyRes.json();
                if (countyData.success) {
                    document.getElementById('county-detail-title').textContent = countyData.data.CountyName;
                }
                
                const economyRes = await fetch(`${API_BASE}/counties/${countyCode}/economy?start_year=2010&end_year=2020`);
                const economyData = await economyRes.json();
                if (economyData.success && economyData.data.length > 0) {
                    renderEconomyCharts(economyData.data);
                }
                
                const agriRes = await fetch(`${API_BASE}/counties/${countyCode}/agriculture?start_year=2010&end_year=2020`);
                const agriData = await agriRes.json();
                if (agriData.success && agriData.data.length > 0) {
                    renderAgricultureCharts(agriData.data, countyCode);
                }
                
                fullpage_api.moveTo(4);
            } catch (error) { console.error(error); }
        }

        // 计算增长率和趋势的辅助函数
        function calculateGrowth(dataArray) {
            if (!dataArray || dataArray.length < 2) return null;
            const first = parseFloat(dataArray[0]) || 0;
            const last = parseFloat(dataArray[dataArray.length - 1]) || 0;
            if (first === 0) return null;
            
            const growthRate = ((last - first) / first * 100).toFixed(1);
            let tag = '';
            let colorClass = '';
            
            if (growthRate > 100) { tag = '高速增长'; colorClass = 'bg-red-50 text-red-700 border-red-200'; }
            else if (growthRate > 50) { tag = '显著提升'; colorClass = 'bg-blue-50 text-blue-700 border-blue-200'; }
            else if (growthRate > 0) { tag = '平稳发展'; colorClass = 'bg-green-50 text-green-700 border-green-200'; }
            else { tag = '需关注'; colorClass = 'bg-orange-50 text-orange-700 border-orange-200'; }
            
            return { rate: growthRate, tag, color: colorClass, value: last };
        }

        // 渲染经济图表 (带智库洞察版)
        function renderEconomyCharts(data) {
            const years = data.map(d => d.Year);
            const latest = data[data.length - 1];
            
            // --- 1. GDP趋势图 (带洞察) ---
            const gdpContainer = document.getElementById('economy-gdp-chart');
            const gdpData = data.map(d => d.GDP ? (d.GDP / 10000).toFixed(2) : 0);
            
            // 计算洞察指标
            const gdpInsight = calculateGrowth(gdpData);
            
            // 动态插入洞察标签 (Insight Badge)
            // 注意：这里我们插入到图表容器的前面
            if (gdpInsight) {
                const insightHTML = `
                    <div class="absolute top-4 right-4 z-10 flex gap-2">
                        <span class="px-2 py-1 text-xs font-bold rounded border ${gdpInsight.color}">
                            ${gdpInsight.tag}
                        </span>
                        <span class="px-2 py-1 text-xs font-bold rounded border bg-slate-50 text-slate-600 border-slate-200">
                            10年增长: ${gdpInsight.rate > 0 ? '+' : ''}${gdpInsight.rate}%
                        </span>
                    </div>
                `;
                // 为了防止重复添加，先清空之前的非canvas元素，或者简单地设置父容器相对定位
                gdpContainer.parentElement.style.position = 'relative';
                // 这是一个简单的hack，把洞察数据直接追加到父容器里，或者由ECharts Title处理
                // 为了不破坏布局，我们利用 ECharts 的 graphic 组件或者 title 组件更稳妥
            }

            const gdpChart = echarts.init(gdpContainer);
            gdpChart.setOption({
                ...CHART_THEME,
                // 利用 ECharts Title 显示洞察数据，规避 DOM 操作的麻烦
                title: {
                    text: gdpInsight ? `{tag|${gdpInsight.tag}}  {rate|增长率: ${gdpInsight.rate}%}` : '',
                    right: 0,
                    top: 0,
                    textStyle: {
                        rich: {
                            tag: {
                                backgroundColor: gdpInsight?.tag === '高速增长' ? '#fef2f2' : '#eff6ff',
                                color: gdpInsight?.tag === '高速增长' ? '#b91c1c' : '#1d4ed8',
                                borderRadius: 4,
                                padding: [4, 8],
                                fontSize: 12,
                                fontWeight: 'bold',
                                borderColor: gdpInsight?.tag === '高速增长' ? '#fecaca' : '#bfdbfe',
                                borderWidth: 1
                            },
                            rate: {
                                color: '#64748b',
                                padding: [4, 0, 4, 5],
                                fontSize: 12
                            }
                        }
                    }
                },
                tooltip: { ...CHART_THEME.tooltip, trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: years,
                    axisLine: CHART_THEME.axisLine,
                    axisLabel: CHART_THEME.axisLabel
                },
                yAxis: {
                    type: 'value',
                    name: '亿元',
                    splitLine: CHART_THEME.splitLine
                },
                series: [{
                    name: 'GDP',
                    data: gdpData,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    lineStyle: { color: CHART_THEME.colors[0], width: 3 },
                    itemStyle: { color: CHART_THEME.colors[0] },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(30, 58, 138, 0.2)' },
                            { offset: 1, color: 'rgba(30, 58, 138, 0)' }
                        ])
                    }
                }]
            });
            
            // --- 2. 产业结构饼图 (保持不变) ---
            if (latest && latest.GDP_Primary && latest.GDP_Secondary && latest.GDP_Tertiary) {
                const structureChart = echarts.init(document.getElementById('economy-structure-chart'));
                structureChart.setOption({
                    ...CHART_THEME,
                    tooltip: { trigger: 'item', ...CHART_THEME.tooltip },
                    legend: { orient: 'vertical', right: 0, top: 'center', textStyle: CHART_THEME.textStyle },
                    series: [{
                        type: 'pie',
                        radius: ['50%', '70%'],
                        center: ['40%', '50%'],
                        itemStyle: { borderColor: '#fff', borderWidth: 2 },
                        data: [
                            { value: latest.GDP_Primary, name: '第一产业', itemStyle: { color: '#059669' } }, // 绿色代表农业
                            { value: latest.GDP_Secondary, name: '第二产业', itemStyle: { color: '#1e3a8a' } }, // 蓝色代表工业
                            { value: latest.GDP_Tertiary, name: '第三产业', itemStyle: { color: '#7c3aed' } }  // 紫色代表服务业
                        ],
                        label: { show: false },
                        emphasis: { label: { show: true, formatter: '{b}\n{d}%' } }
                    }]
                });
            }
            
            // --- 3. 收入水平对比 (带洞察) ---
            const incomeChart = echarts.init(document.getElementById('economy-income-chart'));
            const urbanWage = data.map(d => d.UrbanAvgWage ? (d.UrbanAvgWage / 1000).toFixed(2) : null);
            const ruralIncome = data.map(d => d.RuralDisposableIncome ? (d.RuralDisposableIncome / 1000).toFixed(2) : null);
            
            // 计算城乡收入比 (最新年份)
            let gapText = '';
            if (latest.UrbanAvgWage && latest.RuralDisposableIncome) {
                const gap = (latest.UrbanAvgWage / latest.RuralDisposableIncome).toFixed(2);
                gapText = `城乡收入比: ${gap}`;
            }

            incomeChart.setOption({
                ...CHART_THEME,
                title: {
                    text: gapText ? `{gap|${gapText}}` : '',
                    right: 0,
                    top: 0,
                    textStyle: {
                        rich: {
                            gap: {
                                backgroundColor: '#f8fafc',
                                color: '#475569',
                                borderRadius: 4,
                                padding: [4, 8],
                                fontSize: 11,
                                borderWidth: 1,
                                borderColor: '#cbd5e1'
                            }
                        }
                    }
                },
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { top: 0, left: 0, textStyle: CHART_THEME.textStyle }, // Legend放左边，Insights放右边
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', name: '千元', splitLine: CHART_THEME.splitLine },
                series: [
                    {
                        name: '城镇平均工资',
                        data: urbanWage,
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: CHART_THEME.colors[0], width: 2 },
                        itemStyle: { color: CHART_THEME.colors[0] }
                    },
                    {
                        name: '农村人均可支配收入',
                        data: ruralIncome,
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: CHART_THEME.colors[1], width: 2 },
                        itemStyle: { color: CHART_THEME.colors[1] }
                    }
                ]
            });
            
            // --- 4. 财政收支 (保持不变) ---
            const fiscalChart = echarts.init(document.getElementById('economy-fiscal-chart'));
            const revenue = data.map(d => d.FiscalRevenue ? (d.FiscalRevenue / 10000).toFixed(2) : null);
            const expenditure = data.map(d => d.FiscalExpenditure ? (d.FiscalExpenditure / 10000).toFixed(2) : null);
            
            fiscalChart.setOption({
                ...CHART_THEME,
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { top: 0, textStyle: CHART_THEME.textStyle },
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', name: '亿元', splitLine: CHART_THEME.splitLine },
                series: [
                    { name: '财政收入', data: revenue, type: 'bar', itemStyle: { color: '#059669' }, barMaxWidth: 20 },
                    { name: '财政支出', data: expenditure, type: 'bar', itemStyle: { color: '#b91c1c' }, barMaxWidth: 20 }
                ]
            });
        }

        // 渲染农业图表 (适配新样式)
        async function renderAgricultureCharts(data, countyCode) {
            const years = data.map(d => d.Year);
            const latest = data[data.length - 1];
            
            // 1. 产出趋势
            const outputChart = echarts.init(document.getElementById('agriculture-output-chart'));
            const grain = data.map(d => d.GrainOutput ? (d.GrainOutput / 1000).toFixed(2) : null);
            const meat = data.map(d => d.MeatOutput ? (d.MeatOutput / 1000).toFixed(2) : null);
            
            outputChart.setOption({
                ...CHART_THEME,
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { data: ['粮食产量', '肉类产量'], top: 0 },
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', name: '千吨', splitLine: CHART_THEME.splitLine },
                series: [
                    { name: '粮食产量', data: grain, type: 'bar', itemStyle: { color: '#d97706' }, stack: 'total' },
                    { name: '肉类产量', data: meat, type: 'bar', itemStyle: { color: '#b91c1c' }, stack: 'total' }
                ]
            });
            
            // 2 & 3 (Fetch logic remains same, styling updated via global theme)
            try {
                const cropRes = await fetch(`${API_BASE}/counties/${countyCode}/crops?year=${latest.Year || 2020}`);
                const cropData = await cropRes.json();
                
                if (cropData.success && cropData.data.length > 0) {
                    // Crop Pie Chart
                    const cropChart = echarts.init(document.getElementById('agriculture-crop-chart'));
                    const cropTypes = cropData.data.sort((a, b) => (b.SownArea || 0) - (a.SownArea || 0)).slice(0, 8)
                        .map(d => ({ value: d.SownArea || 0, name: d.CropType }));
                    
                    cropChart.setOption({
                        ...CHART_THEME,
                        tooltip: { trigger: 'item', ...CHART_THEME.tooltip },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            itemStyle: { borderColor: '#fff', borderWidth: 2 },
                            data: cropTypes
                        }]
                    });
                    
                    // Crop Area Bar Chart
                    const areaChart = echarts.init(document.getElementById('agriculture-area-chart'));
                    const topCrops = cropData.data.sort((a, b) => (b.SownArea || 0) - (a.SownArea || 0)).slice(0, 10);
                    
                    areaChart.setOption({
                        ...CHART_THEME,
                        grid: { ...CHART_THEME.grid, left: '15%' },
                        xAxis: { type: 'value', name: '公顷', splitLine: CHART_THEME.splitLine },
                        yAxis: { type: 'category', data: topCrops.map(c => c.CropType), axisLine: CHART_THEME.axisLine },
                        series: [{
                            data: topCrops.map(c => c.SownArea || 0),
                            type: 'bar',
                            itemStyle: { color: '#059669', borderRadius: [0, 4, 4, 0] }
                        }]
                    });
                }
            } catch (error) { console.error(error); }
        }

        // 访谈筛选与加载 (新样式)
        let interviewFilters = { county_code: '', surveyor_id: '', keyword: '' };

        function openInterviewFilter() {
            const modal = document.getElementById('interview-filter-modal');
            if (modal) {
                modal.style.display = 'flex';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);
            }
        }

        function closeInterviewFilter() {
            const modal = document.getElementById('interview-filter-modal');
            if (modal) {
                modal.style.display = 'none';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
            }
        }

        function applyInterviewFilter() {
            interviewFilters.county_code = document.getElementById('filter-county-code').value.trim();
            interviewFilters.surveyor_id = document.getElementById('filter-surveyor-id').value.trim();
            interviewFilters.keyword = document.getElementById('filter-keyword').value.trim();
            loadInterviews();
            closeInterviewFilter();
        }
        
        function resetInterviewFilter() {
            document.getElementById('filter-county-code').value = '';
            document.getElementById('filter-surveyor-id').value = '';
            document.getElementById('filter-keyword').value = '';
            interviewFilters = { county_code: '', surveyor_id: '', keyword: '' };
            loadInterviews();
            closeInterviewFilter();
        }

        async function loadInterviews(quickKeyword = '') {
            try {
                const params = new URLSearchParams();
                if (quickKeyword) params.append('keyword', quickKeyword);
                else {
                    if (interviewFilters.county_code) params.append('county_code', interviewFilters.county_code);
                    if (interviewFilters.surveyor_id) params.append('surveyor_id', interviewFilters.surveyor_id);
                    if (interviewFilters.keyword) params.append('keyword', interviewFilters.keyword);
                }
                params.append('limit', '20');
                
                const response = await fetch(`${API_BASE}/interviews?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('interviews-container');
                    if (result.data.length === 0) {
                        container.innerHTML = '<div class="text-center py-8 text-slate-400">暂无访谈记录</div>';
                        return;
                    }
                    
                    // 智库风：访谈像卡片/引用
                    container.innerHTML = result.data.map(interview => {
                        const date = interview.InterviewDate ? new Date(interview.InterviewDate).toLocaleDateString('zh-CN') : '';
                        return `
                            <div class="report-card bg-white rounded-lg p-5 relative overflow-hidden mb-4">
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-900"></div>
                                <div class="flex justify-between items-start mb-2 pl-3">
                                    <div>
                                        <div class="font-bold text-lg text-slate-800 font-serif flex items-center">
                                            ${interview.IntervieweeName || '匿名受访者'}
                                            <span class="ml-2 text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">${interview.CountyName}</span>
                                        </div>
                                        <div class="text-xs text-slate-400 mt-1">
                                            ${date} ${interview.SurveyorName ? ' · 调研员: ' + interview.SurveyorName : ''}
                                        </div>
                                    </div>
                                    ${interview.Quality ? `<div class="text-amber-500 text-sm"><i class="fas fa-star"></i> ${interview.Quality}</div>` : ''}
                                </div>
                                <div class="pl-3 pt-2 relative mt-2 border-t border-slate-50">
                                    <i class="fas fa-quote-left absolute -left-0 -top-2 text-slate-100 text-3xl z-0"></i>
                                    <div class="text-slate-600 text-sm leading-relaxed relative z-10 font-serif italic">
                                        ${interview.Content ? interview.Content.substring(0, 300) + (interview.Content.length > 300 ? '...' : '') : '暂无记录内容'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) { console.error(error); }
        }

        // 对比分析逻辑
        let selectedCountiesForCompare = [];

        async function openCountySelector() {
            const modal = document.getElementById('county-selector-modal');
            if (modal) {
                modal.style.display = 'flex';
                await loadSelectorProvinces();
                loadCountySelectorList();
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(false);
            }
        }
        
        function closeCountySelector() {
            const modal = document.getElementById('county-selector-modal');
            if (modal) {
                modal.style.display = 'none';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
            }
        }

        async function loadSelectorProvinces() {
            try {
                const response = await fetch(`${API_BASE}/counties`);
                const result = await response.json();
                if (result.success) {
                    const provinces = [...new Set(result.data.filter(c => c.Province).map(c => c.Province))].sort();
                    const select = document.getElementById('selector-province');
                    if (select) {
                        select.innerHTML = '<option value="">全部省份</option>';
                        provinces.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
                    }
                }
            } catch(e) {}
        }

        async function loadCountySelectorList(filters = {}) {
            try {
                const params = new URLSearchParams();
                if (filters.region) params.append('region', filters.region);
                if (filters.province) params.append('province', filters.province);
                const response = await fetch(`${API_BASE}/counties?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('county-selector-list');
                    const validCounties = result.data.filter(c => c.CountyName && !c.CountyName.startsWith('县代码'));
                    const keyword = document.getElementById('selector-search')?.value.trim().toLowerCase();
                    const filtered = keyword ? validCounties.filter(c => c.CountyName.includes(keyword)) : validCounties;
                    
                    container.innerHTML = filtered.map(county => {
                        const isSelected = selectedCountiesForCompare.some(sc => sc.CountyCode === county.CountyCode);
                        return `
                            <div class="bg-white border ${isSelected ? 'border-blue-600 ring-1 ring-blue-600 bg-blue-50' : 'border-slate-200'} rounded p-3 cursor-pointer hover:border-blue-400 transition-all" 
                                 onclick="toggleCountySelection('${county.CountyCode}', '${county.CountyName}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold text-slate-800">${county.CountyName}</div>
                                        <div class="text-xs text-slate-500">${county.Province || ''}</div>
                                    </div>
                                    ${isSelected ? '<i class="fas fa-check-circle text-blue-600"></i>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch(e) {}
        }

        function toggleCountySelection(code, name) {
            const idx = selectedCountiesForCompare.findIndex(c => c.CountyCode === code);
            if (idx >= 0) selectedCountiesForCompare.splice(idx, 1);
            else {
                if (selectedCountiesForCompare.length >= 5) { alert('最多选择5个'); return; }
                selectedCountiesForCompare.push({ CountyCode: code, CountyName: name });
            }
            loadCountySelectorList();
            updateSelectedCountiesDisplay();
        }

        function updateSelectedCountiesDisplay() {
            const container = document.getElementById('selected-counties');
            if (selectedCountiesForCompare.length === 0) container.innerHTML = '<div class="text-sm text-slate-400 italic self-center">暂未选择县域</div>';
            else {
                container.innerHTML = selectedCountiesForCompare.map(c => `
                    <div class="bg-blue-100 text-blue-800 border border-blue-200 rounded px-3 py-1 flex items-center gap-2 text-sm font-medium">
                        <span>${c.CountyName}</span>
                        <button onclick="removeSelectedCounty('${c.CountyCode}')" class="hover:text-blue-900"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            }
        }

        function removeSelectedCounty(code) {
            selectedCountiesForCompare = selectedCountiesForCompare.filter(c => c.CountyCode !== code);
            updateSelectedCountiesDisplay();
        }

        function applyCountySelection() {
            closeCountySelector();
            if (selectedCountiesForCompare.length >= 2) loadCompareData();
        }

        async function loadCompareData() {
            let codes = selectedCountiesForCompare.length > 0 
                ? selectedCountiesForCompare.map(c => c.CountyCode)
                : document.getElementById('compare-input').value.split(',').map(c => c.trim()).filter(c => c);
                
            if (codes.length < 2) { alert('请至少选择2个样本'); return; }
            
            const metric = document.getElementById('compare-metric').value;
            const type = document.getElementById('compare-chart-type').value;
            
            try {
                const params = new URLSearchParams();
                codes.forEach(c => params.append('county_code', c));
                params.append('metric', metric);
                params.append('start_year', '2010');
                params.append('end_year', '2020');
                
                const response = await fetch(`${API_BASE}/compare/trend?${params}`);
                const result = await response.json();
                if (result.success) renderCompareChart(result.data, metric, type);
            } catch(e) { console.error(e); }
        }

        function renderCompareChart(data, metric, chartType) {
            // 1. 渲染左侧趋势图 (折线/柱状/面积)
            const chart = echarts.init(document.getElementById('compare-chart'));
            const years = [...new Set(data.map(d => d.Year))].sort();
            const countyMap = {};
            
            // 数据分组处理
            data.forEach(d => {
                if (!countyMap[d.CountyCode]) countyMap[d.CountyCode] = { name: d.CountyName, data: [] };
                countyMap[d.CountyCode].data.push([d.Year, d[metric] || d.GDP || 0]);
            });
            
            // 构建左侧图表 Series
            const series = Object.values(countyMap).map((c, idx) => ({
                name: c.name,
                type: chartType === 'area' ? 'line' : chartType,
                data: years.map(y => {
                    const pt = c.data.find(p => p[0] === y);
                    // 简单单位换算：如果是大额数据除以10000
                    const val = pt ? pt[1] : 0;
                    return ['GDP','AgriOutputValue','FiscalRevenue','FiscalExpenditure','IndustrialOutput','RetailSales'].includes(metric) ? parseFloat((val/10000).toFixed(2)) : val;
                }),
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                // 面积图样式特殊处理
                areaStyle: chartType === 'area' ? { opacity: 0.3 } : null,
                itemStyle: { color: CHART_THEME.colors[idx % CHART_THEME.colors.length] },
                lineStyle: { width: 3 }
            }));
            
            chart.setOption({
                ...CHART_THEME,
                tooltip: { trigger: 'axis', ...CHART_THEME.tooltip },
                legend: { top: 0, textStyle: CHART_THEME.textStyle },
                grid: { ...CHART_THEME.grid, right: '5%' }, // 调整边距
                xAxis: { type: 'category', data: years, axisLine: CHART_THEME.axisLine },
                yAxis: { type: 'value', splitLine: CHART_THEME.splitLine },
                series: series
            });
            
            // ==========================================
            // 2. 补全：渲染右侧饼图 (最新年份占比)
            // ==========================================
            const pieChart = echarts.init(document.getElementById('compare-pie-chart'));
            
            // 获取最新年份的数据用于画饼
            const latestYear = years[years.length - 1];
            const latestData = data.filter(d => d.Year === latestYear);
            
            if (latestData.length > 0) {
                const pieSeriesData = latestData.map((d, idx) => {
                    let val = d[metric] || d.GDP || 0;
                    // 保持和左图一样的单位换算逻辑
                    if (['GDP','AgriOutputValue','FiscalRevenue','FiscalExpenditure','IndustrialOutput','RetailSales'].includes(metric)) {
                        val = parseFloat((val/10000).toFixed(2));
                    }
                    return {
                        value: val,
                        name: d.CountyName,
                        itemStyle: { color: CHART_THEME.colors[idx % CHART_THEME.colors.length] }
                    };
                });

                pieChart.setOption({
                    ...CHART_THEME,
                    title: {
                        text: `${latestYear}年 占比对比`, // 动态标题
                        left: 'center',
                        top: 20,
                        textStyle: { fontSize: 16, color: '#334155', fontFamily: 'Noto Serif SC' }
                    },
                    tooltip: { 
                        trigger: 'item', 
                        ...CHART_THEME.tooltip,
                        formatter: '{b}: {c} ({d}%)' // 显示数值和百分比
                    },
                    legend: {
                        bottom: 10,
                        left: 'center',
                        textStyle: CHART_THEME.textStyle
                    },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '65%'], // 甜甜圈形状更现代
                        center: ['50%', '55%'],
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 3
                        },
                        label: {
                            show: true,
                            formatter: '{b}\n{d}%',
                            color: '#64748b'
                        },
                        data: pieSeriesData
                    }]
                });
            } else {
                // 如果没有数据，清空图表
                pieChart.clear();
            }
        }

        // 事件监听绑定
        document.getElementById('region-filter')?.addEventListener('change', e => loadCounties({ region: e.target.value, province: document.getElementById('province-filter').value }));
        document.getElementById('province-filter')?.addEventListener('change', e => loadCounties({ region: document.getElementById('region-filter').value, province: e.target.value }));
        document.getElementById('search-input')?.addEventListener('input', e => {
            const kw = e.target.value.toLowerCase();
            document.querySelectorAll('#counties-container > div').forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(kw) ? '' : 'none';
            });
        });
        
        // 模态框点击背景关闭
        document.querySelectorAll('.modal-backdrop').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) modal.style.display = 'none';
                if (typeof fullpage_api !== 'undefined') fullpage_api.setAllowScrolling(true);
            });
        });

        document.getElementById('interview-search')?.addEventListener('input', (e) => {
            const keyword = e.target.value.trim();
            if (keyword) loadInterviews(keyword);
            else loadInterviews();
        });
        
        document.getElementById('selector-region')?.addEventListener('change', e => loadCountySelectorList({ region: e.target.value, province: document.getElementById('selector-province').value }));
        document.getElementById('selector-province')?.addEventListener('change', e => loadCountySelectorList({ region: document.getElementById('selector-region').value, province: e.target.value }));
        document.getElementById('selector-search')?.addEventListener('input', () => loadCountySelectorList());

        // 监听图表类型变化
        document.getElementById('compare-metric')?.addEventListener('change', () => { if(selectedCountiesForCompare.length>=2) loadCompareData(); });
        document.getElementById('compare-chart-type')?.addEventListener('change', () => { if(selectedCountiesForCompare.length>=2) loadCompareData(); });

        setTimeout(loadInterviews, 1000);
    </script>
</body>
</html>